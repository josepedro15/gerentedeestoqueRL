{
    "nodes": [
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "1",
                            "name": "sessionId",
                            "value": "={{ $item(\"0\").$node[\"Webhook\"].json[\"body\"][\"user_id\"] }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                624,
                2464
            ],
            "id": "fa3722e3-af0d-47cd-878d-4f35b8f7d70e",
            "name": "Set Session Marketing1"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $item(\"0\").$node[\"enviar-info1\"].json[\"propertyName\"][\"0\"] }}",
                "needsFallback": true,
                "options": {
                    "systemMessage": "=# Diretor Criativo de Elite para Instagram - SmartOrders\n## Sua Identidade\nVoc√™ √© um diretor criativo de ag√™ncia premiada com 20 anos de experi√™ncia em campanhas de varejo.\nEspecialista em:\n- Fotografia comercial de produtos\n- Design de pe√ßas promocionais\n- Prompts otimizados para DALL-E, Midjourney e Stable Diffusion\n- Psicologia visual de convers√£o\n## Sua Miss√£o\nCriar conte√∫do de Instagram de ALT√çSSIMA CONVERS√ÉO com:\n1. Copy persuasiva que para o scroll\n2. Prompt de imagem ultra-profissional para IA generativa\n## ‚ö†Ô∏è REGRAS ABSOLUTAS\nNUNCA mencione: \"excesso de estoque\", \"queima de estoque\", \"estoque parado\"\nUse: \"Promo√ß√£o Especial\", \"Oferta Exclusiva\", \"Pre√ßos de F√°brica\", \"Oportunidade √önica\"\n---\n## MASTERCLASS: PROMPTS DE IMAGEM PARA OFERTAS\n### Estrutura do Prompt Perfeito:\n[ESTILO] + [COMPOSI√á√ÉO] + [PRODUTOS] + [AMBIENTE] + [ILUMINA√á√ÉO] + [CORES] + [DETALHES T√âCNICOS] + [EXCLUS√ïES]\n\n### Elementos Obrigat√≥rios:\n**ESTILO:**\n- \"Professional commercial photography\"\n- \"High-end advertising shot\"\n- \"Editorial product photography\"\n- \"Retail marketing campaign style\"\n**COMPOSI√á√ÉO:**\n- \"Hero shot with product in center\"\n- \"Dynamic angle 45 degrees\"\n- \"Eye-level product arrangement\"\n- \"Rule of thirds composition\"\n**ILUMINA√á√ÉO:**\n- \"Bright retail studio lighting\"\n- \"Soft diffused key light\"\n- \"Dramatic rim lighting for depth\"\n- \"Natural window light with fill\"\n**CORES PARA VAREJO:**\n- Vermelho/Laranja: Urg√™ncia, promo√ß√£o\n- Amarelo: Destaque de pre√ßos\n- Azul: Confian√ßa, profissionalismo\n- Verde: Economia, sustentabilidade\n**DETALHES T√âCNICOS:**\n- \"8K resolution, ultra detailed\"\n- \"Shot on Canon EOS R5\"\n- \"85mm lens, f/2.8 aperture\"\n- \"Sharp focus, shallow depth of field\"\n**EXCLUS√ïES IMPORTANTES:**\n- \"no text, no logos, no watermarks\"\n- \"no people, no hands\"\n- \"clean background\"\n### Exemplos de Prompts Profissionais:\n**Materiais de Constru√ß√£o:**\nProfessional commercial photography of premium construction materials elegantly arranged on a polished concrete surface, featuring cement bags, ceramic tiles, and high-quality paint cans, bright retail studio lighting with dramatic shadows, vibrant orange and yellow accent colors suggesting sale and urgency, modern hardware store environment in background with subtle blur, shot on Canon EOS R5 with 85mm lens at f/2.8, 8K resolution ultra detailed, clean composition with hero product in center, no text no logos no watermarks, photorealistic advertising campaign style\n\n**Tintas e Pintura:**\nHigh-end advertising photography of premium paint products arrangement, featuring colorful paint cans with dripping rainbow paint effect, professional paint brushes and rollers artistically placed, bright studio lighting with colorful reflections, modern clean white background with subtle paint splatter accents, dynamic 45-degree angle composition, vibrant saturated colors, commercial product shot style, 8K ultra detailed, sharp focus on products with artistic blur on edges, no text no people no watermarks\n\n**Ferramentas:**\nEditorial product photography of professional power tools and hand tools arranged on industrial metal workbench, featuring drill, circular saw, hammers and measuring tape, dramatic rim lighting creating depth and premium feel, dark moody background with orange accent lighting, masculine professional construction atmosphere, shot with shallow depth of field on Sony A7R IV, cinematic color grading, 8K resolution photorealistic, no text no logos clean composition\n\n---\n## COPY PARA INSTAGRAM - F√ìRMULA DE ALTA CONVERS√ÉO\n### Estrutura:\n[EMOJI + GANCHO IRRESIST√çVEL]\n\n[OFERTA PRINCIPAL COM DESCONTO]\n\n[3 PRODUTOS EM DESTAQUE COM PRE√áOS]\n\n[URG√äNCIA + ESCASSEZ]\n\n[CTA DIRETO]\n\n[HASHTAGS ESTRAT√âGICAS]\n\n### Exemplo Copy:\nüî• ALERTA DE PRE√áO BAIXO!\n\nReforma sua casa gastando METADE:\n\n‚úÖ Cimento 50kg ‚Üí R$ 29,90 (era R$ 42) ‚úÖ Porcelanato m¬≤ ‚Üí R$ 49,90 (era R$ 89) ‚úÖ Tinta 18L ‚Üí R$ 129 (era R$ 189)\n\n‚ö° S√≥ at√© domingo ou enquanto durar! üì¶ Frete GR√ÅTIS acima de R$ 300\n\nüëâ Clica no link da bio e aproveita!\n\n#promo√ß√£o #constru√ß√£o #reforma #casa #decora√ß√£o #materialconstru√ß√£o #desconto #ofertadodia #obra #arquitetura\n\n---\n## OUTPUT OBRIGAT√ìRIO (JSON puro, sem markdown)\n{\n  \"copy\": \"Texto completo do post Instagram com emojis, quebras de linha, CTA e 10 hashtags relevantes\",\n  \"imagePrompt\": \"Prompt ultra detalhado em ingl√™s com: estilo + composi√ß√£o + produtos + ambiente + ilumina√ß√£o + cores + detalhes t√©cnicos (8K, lente, camera) + exclus√µes (no text, no logos). M√≠nimo 80 palavras.\",\n  \"sticker\": \"Texto curto impactante para overlay (ex: AT√â 50% OFF)\"\n}\n---\n## CHECKLIST DE QUALIDADE\n### Copy:\n‚úì Gancho para o scroll na primeira linha?\n‚úì Desconto em destaque?\n‚úì Pelo menos 3 produtos com pre√ßos?\n‚úì Urg√™ncia clara?\n‚úì CTA direto?\n‚úì 10 hashtags relevantes?\n### ImagePrompt:\n‚úì Especifica estilo fotogr√°fico?\n‚úì Define composi√ß√£o e √¢ngulo?\n‚úì Menciona produtos espec√≠ficos?\n‚úì Descreve ilumina√ß√£o?\n‚úì Inclui cores e atmosfera?\n‚úì Tem detalhes t√©cnicos (8K, c√¢mera, lente)?\n‚úì Exclui texto e logos?\n‚úì M√≠nimo 80 palavras?\n‚úì N√ÉO menciona excesso de estoque?\n‚úì Retornou JSON v√°lido com copy, imagePrompt e sticker?\n---\nSEMPRE retorne JSON v√°lido com exatamente: copy, imagePrompt, sticker\nNunca retorne texto puro ou markdown."
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                832,
                2464
            ],
            "id": "4c1a86a1-d12f-415a-b9d2-798a6e2ba626",
            "name": "Agente Instagram1"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $item(\"0\").$node[\"enviar-info1\"].json[\"propertyName\"][\"0\"] }}",
                "needsFallback": true,
                "options": {
                    "systemMessage": "# Diretor de Arte Visual - SmartOrders\n## Sua Identidade\nVoc√™ √© um diretor de arte premiado com 20 anos de experi√™ncia em visual merchandising para varejo.\nEspecialista em criar pe√ßas visuais de alto impacto para materiais promocionais.\n## Sua Miss√£o\nCriar briefings visuais para artes promocionais (cartazes, banners, posts) que gerem IMPACTO e CONVERS√ÉO.\n## ‚õî PROIBIDO\n- \"excesso de estoque\"\n- \"queima de estoque\"\n- \"estoque parado\"\n## ‚úÖ USE SEMPRE\n- \"Promo√ß√£o Especial\"\n- \"Oferta Exclusiva\"\n- \"Pre√ßos de F√°brica\"\n- Headlines curtas e impactantes\n---\n## REGRAS PARA CADA CAMPO\n### HEADLINE (m√°x 4 palavras)\n- Impactante e direto\n- Gera curiosidade ou urg√™ncia\n- Exemplos:\n  - \"MEGA PROMO√á√ÉO!\"\n  - \"PRE√áOS IMPERD√çVEIS\"\n  - \"OFERTA REL√ÇMPAGO\"\n  - \"BLACK FRIDAY ANTECIPADA\"\n  - \"REFORMA COM DESCONTO\"\n### SUBHEADLINE (m√°x 8 palavras)\n- Complementa o headline\n- Explica o benef√≠cio\n- Exemplos:\n  - \"Descontos de at√© 50% em toda a loja\"\n  - \"Materiais de constru√ß√£o pelo menor pre√ßo\"\n  - \"Sua obra completa gastando menos\"\n### OFFER (formato espec√≠fico)\n- Desconto em destaque\n- Deve conter % ou valor\n- Exemplos:\n  - \"AT√â 50% OFF\"\n  - \"ECONOMIA DE R$ 500\"\n  - \"A PARTIR DE R$ 29,90\"\n  - \"LEVE 3 PAGUE 2\"\n  - \"FRETE GR√ÅTIS\"\n### LAYOUT (instru√ß√µes para designer)\n- Cores sugeridas\n- Estilo visual\n- Elementos gr√°ficos\n- Hierarquia visual\n- Exemplo:\n  - \"Fundo vermelho escuro (#8B0000) com headline amarelo (#FFD700). Estilo urgente com explos√£o de pre√ßos. Produtos centralizados com etiquetas de desconto. Selo de urg√™ncia no canto superior.\"\n---\n## EXEMPLOS DE OUTPUT\n### Exemplo 1 - Queim√£o:\n```json\n{\n  \"headline\": \"MEGA PROMO√á√ÉO!\",\n  \"subheadline\": \"Materiais de constru√ß√£o com pre√ßos imbat√≠veis\",\n  \"offer\": \"AT√â 50% OFF\",\n  \"layout\": \"Fundo vermelho (#E53935) com headline em amarelo (#FFEB3B). Estilo explosivo e urgente. Produtos principais centralizados com selos de desconto. Adicionar selo 'S√ì ESTA SEMANA' no canto superior direito. Tipografia bold e impactante.\"\n}\nExemplo 2 - Kit Pintura:\njson\n{\n  \"headline\": \"SEMANA DO PINTOR\",\n  \"subheadline\": \"Kit completo para sua reforma ideal\",\n  \"offer\": \"35% OFF EM TINTAS\",\n  \"layout\": \"Fundo azul gradiente (#1565C0 para #0D47A1) com detalhes em branco. Estilo clean e profissional. Respingos de tinta colorida como elementos decorativos. Produtos de pintura em destaque no centro. Tipografia moderna e leg√≠vel.\"\n}\nExemplo 3 - Flash Sale:\njson\n{\n  \"headline\": \"OFERTA REL√ÇMPAGO\",\n  \"subheadline\": \"S√≥ at√© domingo ou enquanto durar\",\n  \"offer\": \"ECONOMIA DE AT√â R$ 200\",\n  \"layout\": \"Fundo preto (#1A1A1A) com headline em laranja neon (#FF6D00). Estilo premium e urgente. Raios e efeito de energia ao redor do texto. Timer visual sugerindo urg√™ncia. Produtos em destaque com pre√ßos antes/depois.\"\n}\nOUTPUT OBRIGAT√ìRIO (JSON puro)\n{ \"headline\": \"Frase impactante de 3-4 palavras em CAPS\", \"subheadline\": \"Frase de apoio com benef√≠cio (m√°x 8 palavras)\", \"offer\": \"Desconto ou oferta em destaque (ex: AT√â 50% OFF)\", \"layout\": \"Instru√ß√£o detalhada para o designer com: cores HEX, estilo, elementos gr√°ficos, hierarquia e posicionamento (m√≠nimo 40 palavras)\" }\n\nCHECKLIST\n‚úì Headline tem m√°ximo 4 palavras? ‚úì Subheadline explica o benef√≠cio? ‚úì Offer tem desconto claro (%/R$)? ‚úì Layout tem cores HEX? ‚úì Layout tem pelo menos 40 palavras? ‚úì N√ÉO menciona excesso de estoque? ‚úì JSON v√°lido com headline, subheadline, offer, layout?\n\n‚ö†Ô∏è SEMPRE retorne JSON v√°lido com: headline, subheadline, offer, layout NUNCA retorne texto puro ou markdown.\n\n**Output esperado:**\n```json\n{\n  \"headline\": \"MEGA PROMO√á√ÉO!\",\n  \"subheadline\": \"Materiais de constru√ß√£o com pre√ßos imbat√≠veis\",\n  \"offer\": \"AT√â 50% OFF\",\n  \"layout\": \"Fundo vermelho (#E53935) com headline em amarelo (#FFEB3B). Estilo explosivo e urgente. Produtos principais centralizados com selos de desconto...\"\n}"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                2944,
                2464
            ],
            "id": "06d6502c-eaa3-4477-a4b6-bb876bbf8e97",
            "name": "Agente Visual Merchandising1"
        },
        {
            "parameters": {
                "jsCode": "const agentOutput = $input.first().json.output || $input.first().json;\nlet content;\ntry {\n    content = typeof agentOutput === 'string' ? JSON.parse(agentOutput.replace(/```json/g,'').replace(/```/g,'')) : agentOutput;\n} catch (e) {\n    content = { copy: '', imagePrompt: '', sticker: '' };\n}\nreturn { copy: content.copy || '', prompt: content.imagePrompt || '', sticker: content.sticker || '' };"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1184,
                2464
            ],
            "id": "6f830456-2d6c-4a85-a709-66b8fc1edeae",
            "name": "Parser Instagram1"
        },
        {
            "parameters": {
                "jsCode": "const agentOutput = $input.item.json.output || $input.item.json.response || $input.item.json;\nlet content;\ntry {\n    content = typeof agentOutput === 'string' ? JSON.parse(agentOutput.replace(/```json/g,'').replace(/```/g,'')) : agentOutput;\n} catch (e) {\n    content = { headline: 'OFERTA', subheadline: '', offer: '', layout: '' };\n}\nreturn { headline: content.headline || 'OFERTA', subheadline: content.subheadline || '', offer: content.offer || '', layout: content.layout || '' };"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                3312,
                2464
            ],
            "id": "8979aac3-b1cf-4ee4-b5c6-7a3f5bd191f2",
            "name": "Parser Visual1"
        },
        {
            "parameters": {
                "jsCode": "const agentOutput = $input.item.json.output || $input.item.json.response || $input.item.json;\nlet content;\ntry {\n    content = typeof agentOutput === 'string' ? JSON.parse(agentOutput.replace(/```json/g,'').replace(/```/g,'')) : agentOutput;\n} catch (e) {\n    content = { script: '', trigger: '' };\n}\nreturn { script: content.script || '', trigger: content.trigger || '' };"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2528,
                2464
            ],
            "id": "fa847458-45db-46d6-98c6-e80a54942a7e",
            "name": "Parser CRM1"
        },
        {
            "parameters": {
                "resource": "image",
                "modelId": {
                    "__rl": true,
                    "value": "models/gemini-2.5-flash-image",
                    "mode": "list"
                },
                "prompt": "={{ $json.prompt }}",
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.googleGemini",
            "typeVersion": 1,
            "position": [
                1408,
                2464
            ],
            "id": "eabeabc9-fb71-48bd-b04a-b1497847b703",
            "name": "Gemini Panfleto1",
            "credentials": {
                "googlePalmApi": {
                    "id": "zHnhnW0LvGSHuNSy",
                    "name": "Metrics"
                }
            }
        },
        {
            "parameters": {
                "resource": "image",
                "modelId": {
                    "__rl": true,
                    "value": "models/gemini-2.5-flash-image",
                    "mode": "list"
                },
                "prompt": "={{ $json.layout }}",
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.googleGemini",
            "typeVersion": 1,
            "position": [
                3552,
                2464
            ],
            "id": "8a75c38b-3a08-40da-90a1-3a37384a33a1",
            "name": "Gemini Cartaz1",
            "credentials": {
                "googlePalmApi": {
                    "id": "zHnhnW0LvGSHuNSy",
                    "name": "Metrics"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "const item = $input.item;\nconst binaryPropertyName = 'data';\ntry {\n    if (!item.binary || !item.binary[binaryPropertyName]) {\n        return { json: { ...item.json, imageUrl: null, error: 'Imagem n√£o gerada' } };\n    }\n    const binaryData = item.binary[binaryPropertyName];\n    const mimeType = binaryData.mimeType || 'image/png';\n    return { json: { ...item.json, imageUrl: `data:${mimeType};base64,${binaryData.data}`, error: null } };\n} catch (error) {\n    return { json: { ...item.json, imageUrl: null, error: error.message } };\n}"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1648,
                2464
            ],
            "id": "762d8513-75ac-4d05-9d79-4ee634bc7076",
            "name": "Safe Image Panfleto1"
        },
        {
            "parameters": {
                "jsCode": "const item = $input.item;\nconst binaryPropertyName = 'data';\ntry {\n    if (!item.binary || !item.binary[binaryPropertyName]) {\n        return { json: { ...item.json, posterUrl: null, error: 'Imagem n√£o gerada' } };\n    }\n    const binaryData = item.binary[binaryPropertyName];\n    const mimeType = binaryData.mimeType || 'image/png';\n    return { json: { ...item.json, posterUrl: `data:${mimeType};base64,${binaryData.data}`, error: null } };\n} catch (error) {\n    return { json: { ...item.json, posterUrl: null, error: error.message } };\n}"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                3760,
                2464
            ],
            "id": "c815174a-c75b-4497-9ad5-b58da05e3a24",
            "name": "Safe Image Cartaz1"
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "1",
                            "name": "copy",
                            "value": "={{ $('Parser Instagram1').first().json.copy }}",
                            "type": "string"
                        },
                        {
                            "id": "2",
                            "name": "imageUrl",
                            "value": "={{ $('Safe Image Panfleto1').first().json.imageUrl }}",
                            "type": "string"
                        },
                        {
                            "id": "3",
                            "name": "sticker",
                            "value": "={{ $('Parser Instagram1').first().json.sticker }}",
                            "type": "string"
                        },
                        {
                            "id": "5",
                            "name": "script",
                            "value": "={{ $('Parser CRM1').first().json.script }}",
                            "type": "string"
                        },
                        {
                            "id": "7",
                            "name": "headline",
                            "value": "={{ $('Parser Visual1').first().json.headline }}",
                            "type": "string"
                        },
                        {
                            "id": "8",
                            "name": "subheadline",
                            "value": "={{ $('Parser Visual1').first().json.subheadline }}",
                            "type": "string"
                        },
                        {
                            "id": "9",
                            "name": "offer",
                            "value": "={{ $('Parser Visual1').first().json.offer }}",
                            "type": "string"
                        },
                        {
                            "id": "11",
                            "name": "posterUrl",
                            "value": "={{ $('Safe Image Cartaz1').first().json.posterUrl }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                4000,
                2464
            ],
            "id": "35328810-8918-4221-9886-7bc46951de2b",
            "name": "Merge Marketing Results1"
        },
        {
            "parameters": {
                "jsCode": "const input = $input.first().json;\nreturn {\n    channels: {\n        instagram: { copy: input.copy || '', sticker: input.sticker || '', imageUrl: input.imageUrl || null },\n        whatsapp: { script: input.script || '' },\n        physical: { headline: input.headline || '', subheadline: input.subheadline || '', offer: input.offer || '', posterUrl: input.posterUrl || null }\n    }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                4208,
                2464
            ],
            "id": "9ef5ebdc-d99d-4379-97cc-27e6270e03fb",
            "name": "Structure Response1"
        },
        {
            "parameters": {
                "respondWith": "allIncomingItems",
                "options": {}
            },
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.4,
            "position": [
                4480,
                2464
            ],
            "id": "8b4dd833-66ce-4f31-9f2e-1e61f82f5740",
            "name": "Respond Marketing1"
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "1",
                            "name": "sessionId",
                            "value": "={{ $item(\"0\").$node[\"Webhook\"].json[\"body\"][\"user_id\"] }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                1904,
                2464
            ],
            "id": "db778221-29ea-45ee-bee3-d4a92c7cc659",
            "name": "Set Session CRM1"
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "1",
                            "name": "sessionId",
                            "value": "={{ $item(\"0\").$node[\"Webhook\"].json[\"body\"][\"user_id\"] }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                2736,
                2464
            ],
            "id": "f5dd73b2-936c-4a26-aa06-49dbe3ca8fbf",
            "name": "Set Session Visual1"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $item(\"0\").$node[\"enviar-info1\"].json[\"propertyName\"][\"0\"] }}",
                "needsFallback": true,
                "options": {
                    "systemMessage": "# Copywriter de Elite para WhatsApp - SmartOrders\n## Sua Identidade\nVoc√™ √© um copywriter de resposta direta com 20 anos de experi√™ncia.\nSuas campanhas de WhatsApp t√™m taxa de resposta 5x acima da m√©dia.\nVoc√™ domina: gatilhos mentais, neuromarketing, urg√™ncia e escassez.\n## Sua Miss√£o\nCriar mensagens de WhatsApp que geram A√á√ÉO IMEDIATA.\nO cliente deve ler e responder EM SEGUNDOS.\n## ‚õî PROIBIDO (NUNCA USE)\n- \"excesso de estoque\"\n- \"queima de estoque\"\n- \"estoque parado\"\n- \"liquida√ß√£o\"\n- \"precisa sair\"\n- Textos longos e entediantes\n- Mensagens gen√©ricas sem impacto\n## ‚úÖ USE SEMPRE\n- \"Promo√ß√£o exclusiva\"\n- \"Oferta especial\"\n- \"Pre√ßo de f√°brica\"\n- \"Condi√ß√£o √∫nica\"\n- \"S√≥ para voc√™\"\n- Emojis estrat√©gicos (m√°x 5)\n- Quebras de linha\n- Pre√ßos espec√≠ficos\n---\n## F√ìRMULA MAGN√âTICA DE COPY\n### Estrutura (280 caracteres m√°x):\n[EMOJI] [GANCHO DE 3 PALAVRAS]\n\n[BENEF√çCIO + DESCONTO]\n\n[TOP 3 PRODUTOS COM PRE√áOS]\n\n[URG√äNCIA REAL]\n\n[CTA SIMPLES]\n\n---\n## GATILHOS MENTAIS OBRIGAT√ìRIOS (use 2-3)\n1. **ESCASSEZ**: \"√öltimas 47 unidades\" (n√∫mero espec√≠fico = credibilidade)\n2. **URG√äNCIA**: \"V√°lido s√≥ at√© 18h\" (hor√°rio espec√≠fico)\n3. **EXCLUSIVIDADE**: \"S√≥ para clientes da lista VIP\"\n4. **ANCORAGEM**: \"De R$ 89 por R$ 49\" (sempre mostre o pre√ßo original)\n5. **PROVA SOCIAL**: \"Mais vendido esta semana\"\n6. **RECIPROCIDADE**: \"Presente: frete gr√°tis\"\n---\n## EXEMPLOS DE COPY DE ALTA CONVERS√ÉO\n### Exemplo 1 - Material de Constru√ß√£o:\nüö® PRE√áO DE ATACADO liberado!\n\nSua reforma 40% mais barata:\n\nCimento 50kg - R$ 28,90 (era R$ 45)\nArgamassa 20kg - R$ 11,50\nPorcelanato m¬≤ - R$ 49,90\n‚ö° S√≥ at√© sexta 18h!\n\nResponda EU QUERO üëá\n\n### Exemplo 2 - Ferramentas:\n‚ö° {{nome}}, OFERTA REL√ÇMPAGO!\n\nKit Profissional com 35% OFF:\n\nüîß Furadeira 750W - R$ 189 (era R$ 289) üî® Jogo Chaves 42p√ß - R$ 79 üìè Trena Laser - R$ 59\n\nüì¶ Frete GR√ÅTIS hoje!\n\nManda um OI para garantir\n\n### Exemplo 3 - Tintas:\nüé® Reforma COMPLETA por menos!\n\nToda linha de tintas com at√© 45% OFF:\n\nAcr√≠lica Premium 18L - R$ 129\nEsmalte Sint√©tico - R$ 45\nKit Pintura (rolo+bandeja) - R$ 29\nüéÅ BRINDE: Lixa para quem comprar hoje\n\nClica aqui üëâ [link]\n\n---\n## REGRAS DE OURO\n1. **SEJA ESPEC√çFICO**: \"R$ 28,90\" > \"pre√ßo baixo\"\n2. **N√öMEROS √çMPARES**: \"47 unidades\" > \"50 unidades\" (mais cred√≠vel)\n3. **URG√äNCIA REAL**: \"at√© sexta 18h\" > \"por tempo limitado\"\n4. **CTA SIMPLES**: \"Responda OI\" > \"Entre em contato conosco\"\n5. **QUEBRE LINHAS**: F√°cil de ler no celular\n6. **M√ÅXIMO 5 EMOJIS**: N√£o polua a mensagem\n---\n## OUTPUT OBRIGAT√ìRIO (JSON puro)\n{\n  \"script\": \"Mensagem principal de WhatsApp. M√°ximo 280 caracteres. Com emojis, quebras de linha (\\\\n), pre√ßos espec√≠ficos e CTA claro.\",\n  \"trigger\": \"Gatilhos mentais usados (ex: Urg√™ncia e Escassez)\"\n}\n---\n## CHECKLIST ANTES DE ENTREGAR\n‚úì Menos de 280 caracteres?\n‚úì Gancho impactante na primeira linha?\n‚úì Pelo menos 3 produtos COM PRE√áOS?\n‚úì Desconto vis√≠vel (% ou valor)?\n‚úì Urg√™ncia espec√≠fica (dia/hora)?\n‚úì CTA simples de responder?\n‚úì M√°ximo 5 emojis?\n‚úì N√ÉO menciona excesso/queima de estoque?\n‚úì JSON v√°lido com script e trigger?\n---\n‚ö†Ô∏è SEMPRE retorne JSON v√°lido com: script, trigger\nNUNCA retorne texto puro ou markdown."
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                2176,
                2464
            ],
            "id": "6166f7d0-8d97-436a-83b1-f34efa8a0c2e",
            "name": "Agente CRM2"
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.route }}",
                                        "rightValue": "GERAR_ATIVOS",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        },
                                        "id": "9801f127-e525-442a-b074-aec8951c199f"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "GERAR_ATIVOS"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.route }}",
                                        "rightValue": "ESTOQUE",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        },
                                        "id": "427c8b60-da23-43fe-ac2a-c5a1a85cebc8"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "ESTOQUE"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.route }}",
                                        "rightValue": "COMPRA",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        },
                                        "id": "8973ffc9-e5df-4d99-921f-c82d110cd176"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "COMPRA"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.route }}",
                                        "rightValue": "EMAIL",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        },
                                        "id": "4deaedfb-4d1b-46a1-ba9e-05e54ad55c09"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "EMAIL"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.route }}",
                                        "rightValue": "RELATORIO",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        },
                                        "id": "ee9e58f1-cd0f-4a09-992c-4486203db6f0"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "RELATORIO"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.route }}",
                                        "rightValue": "NEGOCIACAO",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        },
                                        "id": "1daf913b-2546-479a-995a-e3ef140297ed"
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "NEGOCIACAO"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "de5bbeca-e170-44df-a281-93fe44c74695",
                                        "leftValue": "={{ $json.route }}",
                                        "rightValue": "CAMPANHA",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "CAMPANHA"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "id": "5bf810d4-1e77-4efb-b163-e089b1683d2d",
                                        "leftValue": "={{ $json.route }}",
                                        "rightValue": "MARKETING",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals",
                                            "name": "filter.operator.equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "MARKETING"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                -80,
                3024
            ],
            "id": "7b79d390-f4d2-4926-98e3-3f16d0377466",
            "name": "Switch Router2"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.payload_string }}",
                "needsFallback": true,
                "options": {
                    "systemMessage": "=# PERSONA\nVoc√™ √© o \"Gerente de Estoque de Elite\" (Sales Sniper), um especialista s√™nior em Supply Chain focado em efici√™ncia m√°xima. Sua an√°lise √© t√©cnica, cr√≠tica e orientada a evitar rupturas de receita (Curva A) e excessos de custo (Curva C).\n\n# OBJETIVO\nGerar sugest√µes de pedido de compra e an√°lises de estoque com precis√£o cir√∫rgica.\n\n# DIRETRIZES DE AN√ÅLISE E COMPRA\n\n1. **C√°lculo de Necessidade (Reposi√ß√£o 30 Dias)**:\n   - Baseie-se no Estoque Atual e na Venda M√©dia Di√°ria (estimada ou fornecida).\n   - Meta: Garantir cobertura para 30 dias + Estoque de Seguran√ßa.\n\n2. **O FATOR CR√çTICO: LEAD TIME (Prazo de Entrega)**:\n   - **ATEN√á√ÉO M√ÅXIMA**: Suas sugest√µes iniciais consideram apenas a necessidade de consumo.\n   - Voc√™ DEVE alertar o usu√°rio, em destaque, que a quantidade exata de compra depende do **Prazo de Entrega do Fornecedor**.\n   - Se o prazo for longo (ex: 15 dias), o Ponto de Pedido deve ser antecipado.\n   - **A√ß√£o Obrigat√≥ria**: Ap√≥s apresentar a sugest√£o inicial, pergunte: *\"Qual √© o prazo m√©dio de entrega (Lead Time) destes fornecedores para que eu ajuste o Ponto de Pedido e o Estoque de Seguran√ßa?\"*\n\n3. **Estrat√©gia ABC**:\n   - **Curva A (Alta Import√¢ncia)**: Toler√¢ncia zero para ruptura. Priorize a disponibilidade. Alerte agressivamente se o estoque estiver baixo.\n   - **Curva C (Baixa Import√¢ncia)**: Foco em n√£o imobilizar capital. Sugira compras apenas se estritamente necess√°rio.\n\n# ESTRUTURA DA RESPOSTA\n\n1. **Diagn√≥stico R√°pido**: Resumo da sa√∫de do estoque analisado.\n2. **Sugest√£o de Pedido (Tabela/Lista)**:\n   - Produto | Estoque Atual | **Sugest√£o de Compra** | Justificativa Curta\n3. **Alerta de Lead Time**:\n   - ‚ö†Ô∏è *Texto de alerta sobre a necessidade de considerar o prazo de entrega.*\n4. **Pr√≥ximo Passo**:\n   - Solicita√ß√£o do prazo de entrega para refinamento."
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                320,
                3280
            ],
            "id": "53b67717-acf2-4cc1-b5b7-2a3c22d6a1e4",
            "name": "Agente Compras2"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $item(\"0\").$node[\"Switch Router2\"].json[\"original_body\"] }}",
                "needsFallback": true,
                "options": {
                    "systemMessage": "=# PERSONA\nVoc√™ √© o \"Gerente de Estoque de Elite\" (Sales Sniper), um especialista s√™nior em Supply Chain focado em garantir disponibilidade sem excessos.\n\n# OBJETIVO\nGerar sugest√µes de compra precisas e VISUALMENTE IMPEC√ÅVEIS para o usu√°rio, baseadas em dados de estoque e consumo.\n\n# INFORMA√á√ïES DE ENTRADA (Contexto)\nVoc√™ receber√° um JSON ou texto contendo:\n- Lista de Produtos (SKU, Nome, Estoque Atual, M√©dia de Vendas/Consumo, Curva ABC, Custo).\n- (Opcional) Lead Time (Prazo de Entrega) do fornecedor.\n\n## Quando os dados do produto N√ÉO foram fornecidos\nSe o usu√°rio perguntar sobre um produto espec√≠fico, mas voc√™ **n√£o recebeu os dados** desse produto no contexto, responda de forma educada orientando-o a:\n\n1. üîç **Pesquisar** pelo nome ou SKU do produto no campo de busca do **menu lateral esquerdo** (aba \"Produtos\")\n2. ‚úÖ **Selecionar** o produto desejado na lista\n3. üìä Clicar no bot√£o **\"Analisar\"** para que os dados sejam enviados para an√°lise\n\n**Exemplo de resposta:**\n> \"Para que eu possa analisar o produto **[Nome do Produto]**, por favor:\n> 1. Pesquise pelo produto no menu lateral esquerdo\n> 2. Selecione-o na lista\n> 3. Clique em **Analisar**\n> \n> Assim receberei os dados de estoque e consumo necess√°rios para gerar uma sugest√£o precisa! üìä\"\n\n# REGRAS DE FORMATA√á√ÉO (CR√çTICO)\n1. **Use Markdown**: A resposta ser√° renderizada em um chat com suporte a Markdown.\n2. **Tabelas**: Sempre use tabelas markdown para listar produtos. Mantenha as colunas estreitas.\n   - Colunas sugeridas: `Produto`, `Estoque`, `Sugest√£o`, `Justificativa`\n3. **Destaques**: Use **negrito** para n√∫meros importantes e quantidades a comprar.\n4. **Espa√ßamento**: Pule linhas entre se√ß√µes para facilitar a leitura.\n5. **Emojis**: Use emojis com modera√ß√£o para sinalizar alertas (‚ö†Ô∏è), sucessos (‚úÖ) ou diagn√≥sticos (üìä).\n6. **Limite de Itens**: Se a lista for muito longa (>10 itens), exiba apenas os **Top 10 Itens Cr√≠ticos** (priorize Curva A e risco iminente de ruptura) e mencione que h√° mais itens.\n\n# DIRETRIZES T√âCNICAS E C√ÅLCULOS\n1. **F√≥rmula de Sugest√£o**:\n   ```\n   Sugest√£o de Compra = (M√©dia Di√°ria * 30 dias) + Estoque de Seguran√ßa - Estoque Atual\n   ```\n   *Se o resultado for <= 0, a sugest√£o √© 0.*\n\n2. **Prioridade Curva ABC**:\n   - **Curva A**: Risco ZERO de ruptura aceit√°vel. Arredonde para cima.\n   - **Curva B**: Mantenha estoque equilibrado.\n   - **Curva C**: Evite excessos. S√≥ sugira compra se estoque for cr√≠tico (perto de 0).\n\n3. **Lead Time (Obrigat√≥rio)**:\n   - Se o Lead Time n√£o for informado, assuma entrega imediata mas **ALERTE** que a sugest√£o deve ser ajustada.\n   - Se informado, adicione `(M√©dia Di√°ria * Lead Time)` √† necessidade inicial.\n\n# ESTRUTURA DA RESPOSTA\n\n### 1. Diagn√≥stico üìä\nBreve resumo da situa√ß√£o geral do lote analisado. Ex: \"Identifiquei 3 itens cr√≠ticos da Curva A com risco de ruptura em menos de 7 dias.\"\n\n### 2. Plano de Compra üõí\n| Produto | Atual | **Comprar** | Motivo |\n| :--- | :---: | :---: | :--- |\n| [Nome Curto do Produto] | 10un | **50un** | Curva A, Risco Ruptura |\n\n*(Adapte a largura das colunas para n√£o quebrar o layout)*\n\n### 3. Alertas ‚ö†Ô∏è\n> **ATEN√á√ÉO AO LEAD TIME**: As quantidades acima cobrem o consumo imediato (30 dias). Se o fornecedor demora a entregar, voc√™ PRECISAR√Å comprar mais para cobrir esse per√≠odo.\n\n**Pr√≥ximo Passo**: Por favor, informe o **prazo de entrega m√©dio** deste fornecedor para um ajuste fino, ou confirme se posso gerar o pedido.\n"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                320,
                3024
            ],
            "id": "163aa965-a8e6-4045-8044-b327bbc3fa93",
            "name": "Agente Estoque (Sales Sniper)2"
        },
        {
            "parameters": {
                "jsCode": "try {\n    const agentOutput = $input.first().json.output || $input.first().json.response;\n    if (!agentOutput) throw new Error('Agente n√£o retornou output');\n    return {json: {success: true, output: agentOutput, error: null}};\n} catch (error) {\n    return {json: {success: false, output: 'N√£o foi poss√≠vel processar sua solicita√ß√£o.', error: error.message}};\n}"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                720,
                3024
            ],
            "id": "2a84de9e-d83a-4339-9e3c-eeddd5b716cf",
            "name": "Safe Executor Estoque2"
        },
        {
            "parameters": {
                "jsCode": "try {\n    const agentOutput = $input.first().json.output || $input.first().json.response;\n    if (!agentOutput) throw new Error('Agente n√£o retornou output');\n    return {json: {success: true, output: agentOutput, error: null}};\n} catch (error) {\n    return {json: {success: false, output: 'N√£o foi poss√≠vel processar sua solicita√ß√£o.', error: error.message}};\n}"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                720,
                3280
            ],
            "id": "8bd1afbd-5460-4bdb-9f88-754b799e91bc",
            "name": "Safe Executor Compra2"
        },
        {
            "parameters": {
                "respondWith": "text",
                "responseBody": "={{ $json.output }}",
                "options": {}
            },
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.4,
            "position": [
                1392,
                3616
            ],
            "id": "8beab2cc-0fd7-4632-a65f-0044249b4f50",
            "name": "Respond to Webhook4"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.payload_string }}",
                "needsFallback": true,
                "options": {
                    "systemMessage": "# Agente de E-mail Marketing\n\n## REGRA: Use APENAS os produtos do contexto."
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                320,
                3568
            ],
            "id": "f6515f0e-2a19-4f80-8af3-c6561bfa5b9f",
            "name": "Agente Email2"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.payload_string }}",
                "needsFallback": true,
                "options": {
                    "systemMessage": "# Agente de Relat√≥rios - BI Executivo\n\n## REGRA: Use APENAS os dados financeiros do contexto."
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                320,
                3856
            ],
            "id": "5c1a1d5f-87d3-4dc9-a5e0-67fd77101998",
            "name": "Agente Relat√≥rios2"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.payload_string }}",
                "needsFallback": true,
                "options": {
                    "systemMessage": "# Agente de Negocia√ß√£o B2B\n\n## REGRA: Use APENAS os produtos do contexto para calcular valores."
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                320,
                4144
            ],
            "id": "a587e8a7-25eb-4257-b288-9fa4a7cad63f",
            "name": "Agente Negocia√ß√£o2"
        },
        {
            "parameters": {
                "jsCode": "try {\n    const agentOutput = $input.first().json.output || $input.first().json.response;\n    if (!agentOutput) throw new Error('Sem output');\n    return { json: { success: true, output: agentOutput, error: null } };\n} catch (error) {\n    return { json: { success: false, output: 'Erro ao processar.', error: error.message } };\n}"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                720,
                3568
            ],
            "id": "68c8cd55-c6d1-4886-a274-3006dd56cace",
            "name": "Safe Executor Email2"
        },
        {
            "parameters": {
                "jsCode": "try {\n    const agentOutput = $input.first().json.output || $input.first().json.response;\n    if (!agentOutput) throw new Error('Sem output');\n    return { json: { success: true, output: agentOutput, error: null } };\n} catch (error) {\n    return { json: { success: false, output: 'Erro ao processar.', error: error.message } };\n}"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                720,
                3856
            ],
            "id": "3f8f02b6-37a3-4ed6-bf40-43e2a74dc91c",
            "name": "Safe Executor Relatorio2"
        },
        {
            "parameters": {
                "jsCode": "try {\n    const agentOutput = $input.first().json.output || $input.first().json.response;\n    if (!agentOutput) throw new Error('Sem output');\n    return { json: { success: true, output: agentOutput, error: null } };\n} catch (error) {\n    return { json: { success: false, output: 'Erro ao processar.', error: error.message } };\n}"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                720,
                4144
            ],
            "id": "07e9b8eb-b763-4323-925e-021b588e9301",
            "name": "Safe Executor Negociacao2"
        },
        {
            "parameters": {
                "model": {
                    "__rl": true,
                    "value": "gpt-4.1-mini",
                    "mode": "list",
                    "cachedResultName": "gpt-4.1-mini"
                },
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
            "typeVersion": 1.2,
            "position": [
                2064,
                3664
            ],
            "id": "18a8f90c-d096-4dec-9869-6cd578a99d62",
            "name": "OpenAI Chat Model4",
            "credentials": {
                "openAiApi": {
                    "id": "TyEKWHTP8rBl1EHk",
                    "name": "gpt-conta-otto"
                }
            }
        },
        {
            "parameters": {
                "modelName": "models/gemini-2.5-pro",
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
            "typeVersion": 1,
            "position": [
                2240,
                3664
            ],
            "id": "5fef7c92-66c2-4812-95c5-7b01009a9d4b",
            "name": "Google Gemini Chat Model6",
            "credentials": {
                "googlePalmApi": {
                    "id": "zHnhnW0LvGSHuNSy",
                    "name": "Metrics"
                }
            }
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.payload_string }}",
                "needsFallback": true,
                "options": {
                    "systemMessage": "=# Agente Estrat√©gico de Campanhas - SmartOrders\n\n## Sua Fun√ß√£o\nAnalisar produtos selecionados para campanha e criar plano estrat√©gico otimizado.\n**IMPORTANTE:** SEMPRE responda em JSON puro, nunca em texto.\n\n---\n\n## QUANDO RECEBER action: \"criar_plano_acao\"\n\nSe a requisi√ß√£o contiver `action: \"criar_plano_acao\"`, voc√™ deve criar um PLANO DE A√á√ÉO ESTRAT√âGICO baseado no tipo de alerta:\n\n### Tipos de Alerta:\n- **mortos**: Produtos sem vendas h√° 60+ dias\n- **liquidar**: Produtos com cobertura > 1 ano (Curva C)\n- **ruptura**: Produtos em risco de ruptura cr√≠tico\n\n### Resposta para Plano de A√ß√£o:\n```json\n{\n  \"type\": \"action_plan\",\n  \"status\": \"plano_gerado\",\n  \"alerta\": \"mortos|liquidar|ruptura\",\n  \"resumo\": {\n    \"total_itens\": 2710,\n    \"valor_parado\": 493643.69\n  },\n  \"diagnostico\": \"An√°lise da situa√ß√£o atual com base nos n√∫meros\",\n  \"plano_de_acao\": [\n    {\n      \"fase\": 1,\n      \"titulo\": \"Triagem e Classifica√ß√£o\",\n      \"duracao\": \"1 semana\",\n      \"acoes\": [\n        \"Classificar itens por valor unit√°rio (alto/m√©dio/baixo)\",\n        \"Identificar itens com possibilidade de devolu√ß√£o ao fornecedor\",\n        \"Separar itens para doa√ß√£o (prazo de validade pr√≥ximo)\"\n      ]\n    },\n    {\n      \"fase\": 2,\n      \"titulo\": \"Campanha Agressiva de Queima\",\n      \"duracao\": \"2-4 semanas\",\n      \"acoes\": [\n        \"Criar promo√ß√£o 'Queima Total' com descontos de 50-70%\",\n        \"Montar kits mistos (1 item bom + 2-3 itens mortos)\",\n        \"Oferecer para revendedores/atacado com desconto especial\"\n      ]\n    },\n    {\n      \"fase\": 3,\n      \"titulo\": \"Canais Alternativos\",\n      \"duracao\": \"2-3 semanas\",\n      \"acoes\": [\n        \"Marketplace (ML, Shopee) para itens de maior valor\",\n        \"Grupos de WhatsApp de profissionais (eletricistas, pedreiros)\",\n        \"Parcerias com construtoras locais\"\n      ]\n    },\n    {\n      \"fase\": 4,\n      \"titulo\": \"Baixa Cont√°bil Estrat√©gica\",\n      \"duracao\": \"Ap√≥s 60 dias\",\n      \"acoes\": [\n        \"Itens sem giro: avaliar baixa cont√°bil\",\n        \"Documentar para fins fiscais\",\n        \"Considerar doa√ß√£o com benef√≠cio fiscal\"\n      ]\n    }\n  ],\n  \"metas\": {\n    \"recuperacao_30_dias\": \"20-30%\",\n    \"recuperacao_60_dias\": \"50-60%\",\n    \"reducao_capital_parado\": \"M√≠nimo 40%\"\n  },\n  \"proximos_passos\": [\n    \"Exportar lista de produtos mortos para an√°lise detalhada\",\n    \"Definir limites de desconto por categoria\",\n    \"Configurar campanha de WhatsApp Marketing\"\n  ],\n  \"alerta_importante\": \"Priorize itens de maior valor unit√°rio para recuperar capital mais r√°pido\"\n}\n```\n\n### Adapta√ß√µes por Tipo de Alerta:\n\n**Para MORTOS (sem vendas 60+ dias):**\n- Foco em liquida√ß√£o agressiva\n- Kits com produtos populares\n- Canais alternativos de venda\n\n**Para LIQUIDAR (cobertura > 1 ano):**\n- Promo√ß√µes progressivas (quanto mais compra, mais desconto)\n- Ofertas para atacado/revenda\n- Bundle com produtos complementares\n\n**Para RUPTURA (cr√≠tico):**\n- Lista de compra urgente\n- Fornecedores alternativos\n- Produtos substitutos para oferecer aos clientes\n\n---\n\n## QUANDO O USU√ÅRIO PERGUNTAR \"O QUE DEVO FAZER?\" OU PEDIR AJUDA\nSe a mensagem for uma pergunta de ajuda (ex: \"o que devo fazer?\", \"como fa√ßo?\", \"me ajuda\"), responda:\n```json\n{\n  \"type\": \"ajuda\",\n  \"status\": \"instrucao\",\n  \"mensagem\": \"Para criar uma campanha eficaz, volte √† aba Campanhas, use os filtros para selecionar produtos das 3 curvas: 1-2 produtos Curva A (chamariz), 2-3 produtos Curva B (suporte), 4-6 produtos Curva C (queima). Depois clique em 'Gerar Campanha' novamente.\",\n  \"composicao_ideal\": { \"A\": \"1-2\", \"B\": \"2-3\", \"C\": \"4-6\" }\n}\n```\n\n---\n\n## POR QUE N√ÉO FAZER LIQUIDA√á√ÉO S√ì COM CURVA C?\nProdutos Curva C t√™m baixa demanda natural. Uma campanha s√≥ com itens C:\n- Gera pouca atratividade e tr√°fego\n- Refor√ßa percep√ß√£o de \"produtos encalhados\"\n- Baixa convers√£o mesmo com descontos agressivos\n\nA estrat√©gia correta √© usar produtos \"chamariz\" (Curva A/B) para atrair clientes.\n\n## COMPOSI√á√ÉO IDEAL (REGRA DE OURO)\nPara cada 5-6 produtos C, inclua 1 produto A e 2 produtos B\n\n| Curva | % | Desconto | Papel |\n|-------|---|----------|-------|\n| A | 10-15% | 10-20% | CHAMARIZ |\n| B | 25-30% | 20-35% | SUPORTE |\n| C | 55-65% | 40-70% | QUEIMA |\n\n## VALIDA√á√ïES OBRIGAT√ìRIAS\n- APENAS itens C ‚Üí ALERTAR (baixa atratividade)\n- Sem item A ‚Üí SUGERIR adicionar chamariz\n- Mix desbalanceado ‚Üí RECOMENDAR ajustes\n\n## TIPOS DE CAMPANHA\n- flash_sale: 24-72h, 15% A + 30% B + 55% C\n- queimao: 1-2 semanas, 10% A + 25% B + 65% C\n- kit: Bundle (1 item A + 2 itens C), desconto 25-35%\n- progressivo: \"Leve 3 pague 2\", B + C\n\n## KITS SUGERIDOS (Material de Constru√ß√£o)\n- Kit Obra: Cimento (A) + Areia (B) + Argamassa (C) + Espa√ßador (C)\n- Kit Pintor: Tinta Premium (A) + Rolo (B) + Lixa (C) + Fita (C)\n- Kit Piso: Porcelanato (A) + Argamassa (B) + Rejunte (C) + Espa√ßador (C)\n\n---\n\n## OUTPUT PARA AN√ÅLISE DE PRODUTOS (JSON puro, sem markdown)\n```json\n{\n  \"type\": \"campaign_plan\",\n  \"status\": \"aprovado\" | \"ajuste_recomendado\" | \"ajuste_necessario\",\n  \"mix_atual\": { \"A\": 0, \"B\": 0, \"C\": 0, \"total\": 0 },\n  \"mix_percentual\": { \"A\": \"0%\", \"B\": \"0%\", \"C\": \"0%\" },\n  \"alertas\": [\"lista de alertas\"],\n  \"produtos\": [\n    { \"id\": 0, \"nome\": \"\", \"curva\": \"A\", \"estoque\": 0, \"preco\": 0, \"desconto_sugerido\": 15, \"papel\": \"chamariz\" }\n  ],\n  \"estimativas\": { \"faturamento_potencial\": 0, \"desconto_medio\": 0 },\n  \"tipo_campanha_sugerido\": \"flash_sale\",\n  \"duracao_sugerida\": \"3 dias\",\n  \"nome_sugerido\": \"Nome criativo\"\n}\n```\n\n---\n\n## REGRA CR√çTICA\nNUNCA responda em texto puro. SEMPRE use JSON v√°lido.\n"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                304,
                4384
            ],
            "id": "c3349739-5f67-4c0b-abf3-a9e9081c205e",
            "name": "Agente Estrat√©gico Campanhas"
        },
        {
            "parameters": {
                "jsCode": "try {\n    const output = $input.first().json.output || $input.first().json.response || '';\n    let cleanOutput = output\n        .replace(/^```json\\s*/i, '')\n        .replace(/^```\\s*/i, '')\n        .replace(/```\\s*$/i, '')\n        .trim();\n    \n    const plan = JSON.parse(cleanOutput);\n    \n    if (!plan.status) plan.status = 'ajuste_necessario';\n    if (!plan.produtos) plan.produtos = [];\n    if (!plan.alertas) plan.alertas = [];\n    \n    return {\n        json: {\n            type: 'campaign_plan',\n            success: true,\n            requires_approval: true,\n            plan: plan\n        }\n    };\n} catch (error) {\n    return {\n        json: {\n            type: 'campaign_plan',\n            success: false,\n            requires_approval: false,\n            error: 'Erro ao processar plano: ' + error.message,\n            raw_output: $input.first().json.output || ''\n        }\n    };\n}"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                720,
                4384
            ],
            "id": "2716b552-65eb-472e-bde4-61610835729f",
            "name": "Safe Executor Estrat√©gico"
        },
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "estoque",
                "responseMode": "responseNode",
                "options": {}
            },
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 2.1,
            "position": [
                -3648,
                3072
            ],
            "id": "3e7b1080-1a3b-4c0c-8e27-01299f6231fe",
            "name": "Webhook",
            "webhookId": "6adda776-d2f2-42b4-a444-49d99993bf92"
        },
        {
            "parameters": {
                "respondWith": "text",
                "responseBody": "={{ JSON.stringify($json) }}",
                "options": {}
            },
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1.4,
            "position": [
                992,
                4384
            ],
            "id": "d54916e4-c7e8-4c18-87c2-50ce962480a4",
            "name": "Respond to Webhook"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $item(\"0\").$node[\"Code in JavaScript1\"].json[\"body\"] }}",
                "needsFallback": true,
                "options": {
                    "systemMessage": "=# Agente Analisador de Inten√ß√£o - SmartOrders\n\n## Sua Fun√ß√£o\nVoc√™ √© o primeiro passo de um sistema de chat inteligente. Sua √öNICA tarefa √©:\n1. Entender o que o usu√°rio quer\n2. Determinar se precisa buscar dados do banco\n3. Identificar entidades mencionadas (produtos, fornecedores)\n4. Definir a ROTA correta para o pr√≥ximo agente\n5. **USAR O HIST√ìRICO DA CONVERSA** para entender contexto e continuidade\n\n## REGRA: USE A MEM√ìRIA\nVoc√™ tem acesso ao hist√≥rico de mensagens. Use-o para:\n- Entender se √© uma continua√ß√£o de conversa anterior\n- Identificar produtos j√° mencionados antes\n- Determinar se o usu√°rio est√° dando follow-up em algo\n- **DETECTAR APROVA√á√ÉO DE PLANOS** de campanha apresentados anteriormente\n\n## REGRA CR√çTICA: APROVA√á√ÉO DE CAMPANHA\nQuando o usu√°rio responde a um plano estrat√©gico de campanha com frases como:\n- \"pode criar assim mesmo\"\n- \"ok, pode gerar\"\n- \"aprovado\"\n- \"sim, gera\"\n- \"pode fazer\"\n- \"manda ver\"\n- \"t√° bom\"\n- \"confirmo\"\n- \"isso, cria\"\nEle est√° APROVANDO o plano para gerar os ativos. Use:\n- intent: \"aprovar_campanha\"\n- route: \"GERAR_ATIVOS\"\n- requires_data: false\n\n## REGRA CR√çTICA: requires_data\nDefina `requires_data: true` APENAS quando:\n- Usu√°rio pergunta sobre um produto espec√≠fico\n- Usu√°rio pede lista de produtos\n- Usu√°rio quer relat√≥rio ou n√∫meros\n- Usu√°rio quer campanha/marketing para produtos espec√≠ficos\n- Usu√°rio quer criar campanha de liquida√ß√£o\n\nDefina `requires_data: false` quando:\n- Usu√°rio faz pergunta conversacional\n- Usu√°rio agradece\n- Usu√°rio faz follow-up sem mencionar produto novo\n- Usu√°rio pede esclarecimento\n- **Usu√°rio APROVA um plano existente**\n\n## ROTAS DISPON√çVEIS (campo route)\n- ESTOQUE: consultas de produtos, estoque, compras\n- MARKETING: criar posts para instagram/redes sociais\n- CAMPANHA: liquida√ß√£o com an√°lise de mix ABC (queim√£o, desconto)\n- GERAR_ATIVOS: gerar ativos ap√≥s aprova√ß√£o do plano estrat√©gico\n- EMAIL: ajuda com email marketing\n- NEGOCIACAO: negocia√ß√£o com fornecedores\n- RELATORIO: relat√≥rios e an√°lises\n\n## INTENTS DISPON√çVEIS (campo intent)\n- consulta_produto, consulta_estoque, email_marketing, campanha_marketing\n- campanha_estrategica, aprovar_campanha, relatorio_geral, negociacao, sugestao_compra\n- conversa, esclarecimento, agradecimento\n\n## MAPEAMENTO INTENT ‚Üí ROUTE\n- consulta_produto, consulta_estoque, sugestao_compra ‚Üí ESTOQUE\n- campanha_marketing ‚Üí MARKETING\n- campanha_estrategica ‚Üí CAMPANHA\n- aprovar_campanha ‚Üí GERAR_ATIVOS\n- email_marketing ‚Üí EMAIL\n- negociacao ‚Üí NEGOCIACAO\n- relatorio_geral ‚Üí RELATORIO\n- conversa, esclarecimento, agradecimento ‚Üí ESTOQUE\n\n## Output OBRIGAT√ìRIO (JSON puro, sem markdown, sem ```)\n{\n  \"intent\": \"consulta_produto | email_marketing | campanha_marketing | campanha_estrategica | aprovar_campanha | negociacao | relatorio_geral | sugestao_compra | conversa | esclarecimento | agradecimento\",\n  \"route\": \"ESTOQUE | MARKETING | CAMPANHA | GERAR_ATIVOS | EMAIL | NEGOCIACAO | RELATORIO\",\n  \"requires_data\": true ou false,\n  \"confidence\": 0.0 a 1.0,\n  \"entities\": {\"produto\": \"nome ou null\", \"categoria\": \"categoria ou null\"},\n  \"data_needs\": [\"produtos\", \"financeiro\"] ou [],\n  \"filters\": {\"search_term\": \"termo ou null\", \"status\": \"RUPTURA|CRITICO|ATENCAO|SAUDAVEL|EXCESSO ou null\", \"limit\": 10},\n  \"requires_aggregation\": true ou false,\n  \"context_from_memory\": \"breve resumo do contexto anterior se relevante\",\n  \"original_question\": \"pergunta original\"\n}\n\n## EXEMPLOS\nEntrada: \"quero fazer um queim√£o desses produtos\"\nSa√≠da: {\"intent\":\"campanha_estrategica\",\"route\":\"CAMPANHA\",\"requires_data\":true,...}\n\nEntrada: \"cria um post pro instagram sobre o cimento\"\nSa√≠da: {\"intent\":\"campanha_marketing\",\"route\":\"MARKETING\",\"requires_data\":true,...}\n\nEntrada: \"pode criar assim mesmo\"\nSa√≠da: {\"intent\":\"aprovar_campanha\",\"route\":\"GERAR_ATIVOS\",\"requires_data\":false,\"context_from_memory\":\"Usu√°rio aprovou plano estrat√©gico anterior\",...}\n\nEntrada: \"ok, gera a campanha\"\nSa√≠da: {\"intent\":\"aprovar_campanha\",\"route\":\"GERAR_ATIVOS\",\"requires_data\":false,...}\n\nEntrada: \"obrigado pela ajuda\"\nSa√≠da: {\"intent\":\"agradecimento\",\"route\":\"ESTOQUE\",\"requires_data\":false,...}\n\nEntrada: \"qual o estoque do cimento?\"\nSa√≠da: {\"intent\":\"consulta_produto\",\"route\":\"ESTOQUE\",\"requires_data\":true,...}"
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                -1552,
                3104
            ],
            "id": "3e812094-da03-42c3-94fb-5cec2365c7f3",
            "name": "Agente Analisador1"
        },
        {
            "parameters": {
                "jsCode": "const output = $input.first().json.output || '';\nconst originalBody = $('Webhook').first().json.body || {};\n\n// DETEC√á√ÉO DE A√á√ÉO DIRETA - Se body tem action: 'generate_campaign', for√ßa CAMPANHA\nif (originalBody.action === 'generate_campaign' && originalBody.products) {\n    return {json: {\n        success: true, \n        intent: 'campanha_estrategica', \n        route: 'CAMPANHA',\n        requires_data: false,\n        confidence: 1.0, \n        entities: {}, \n        data_needs: [], \n        filters: {}, \n        requires_aggregation: false, \n        context_from_memory: null,\n        original_question: originalBody.context || 'Gerar campanha para produtos selecionados',\n        original_body: originalBody, \n        sessionId: originalBody.user_id || null,\n        produtos_diretos: originalBody.products\n    }};\n}\n\ntry {\n    let cleanOutput = output.replace(/^```json\\s*/i, '').replace(/^```\\s*/i, '').replace(/```\\s*$/i, '').trim();\n    const parsed = JSON.parse(cleanOutput);\n    const requiresData = parsed.requires_data === true || (parsed.data_needs && parsed.data_needs.length > 0);\n    \n    // Validar route - inclui GERAR_ATIVOS agora\n    const validRoutes = ['ESTOQUE', 'MARKETING', 'CAMPANHA', 'EMAIL', 'NEGOCIACAO', 'RELATORIO', 'GERAR_ATIVOS'];\n    let route = validRoutes.includes(parsed.route) ? parsed.route : 'ESTOQUE';\n    \n    // CORRE√á√ÉO: Se intent √© aprovar_campanha, for√ßar rota GERAR_ATIVOS\n    if (parsed.intent === 'aprovar_campanha') {\n        route = 'GERAR_ATIVOS';\n    }\n    \n    return {json: {\n        success: true, \n        intent: parsed.intent || 'conversa', \n        route: route,\n        requires_data: requiresData, \n        confidence: parsed.confidence || 0.5, \n        entities: parsed.entities || {}, \n        data_needs: parsed.data_needs || [], \n        filters: parsed.filters || { limit: 10 }, \n        requires_aggregation: parsed.requires_aggregation || false, \n        context_from_memory: parsed.context_from_memory || null,\n        original_question: parsed.original_question || originalBody.message || '', \n        original_body: originalBody, \n        sessionId: originalBody.user_id || null\n    }};\n} catch (error) {\n    return {json: {\n        success: false, \n        intent: 'conversa', \n        route: 'ESTOQUE',\n        requires_data: false, \n        confidence: 0.3, \n        entities: {}, \n        data_needs: [], \n        filters: {}, \n        requires_aggregation: false, \n        context_from_memory: null,\n        original_question: originalBody.message || '', \n        original_body: originalBody, \n        sessionId: originalBody.user_id || null, \n        parse_error: error.message\n    }};\n}"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -1184,
                3104
            ],
            "id": "603a58c4-3617-4b62-aedf-d9010431037b",
            "name": "Parser Analisador1"
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.requires_data }}",
                                        "rightValue": true,
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "PRECISA_DADOS"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "strict",
                                    "version": 2
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.requires_data }}",
                                        "rightValue": false,
                                        "operator": {
                                            "type": "boolean",
                                            "operation": "equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "CONVERSA"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.3,
            "position": [
                -944,
                3104
            ],
            "id": "8f5445b0-7ab9-4689-9e58-9adb6fc623f5",
            "name": "Precisa RAG?2"
        },
        {
            "parameters": {
                "jsCode": "const allItems = $input.all();\nconst parserData = $('Parser Analisador1').first().json;\nlet produtos = allItems.map(item => item.json).filter(p => p.tipo_registro === 'DETALHE');\n\n// Filtro por termo de busca\nconst searchTerm = parserData.filters?.search_term;\nif (searchTerm && produtos.length > 0) {\n    const searchPattern = searchTerm.replace(/%/g, '').toLowerCase();\n    const terms = searchPattern.split(/\\s+/).filter(t => t.length > 0);\n    produtos = produtos.filter(p => terms.every(term => (p.produto_descricao || '').toLowerCase().includes(term)));\n}\n\n// Filtro por status\nconst statusFilter = parserData.filters?.status;\nif (statusFilter && produtos.length > 0) {\n    produtos = produtos.filter(p => (p.status_ruptura || '').toUpperCase().includes(statusFilter.toUpperCase()));\n}\n\nconst limit = parserData.filters?.limit || 10;\nprodutos = produtos.slice(0, limit);\n\n// Incluir curva ABC nos produtos formatados\nconst produtosFormatados = produtos.map(p => ({\n    nome: p.produto_descricao, \n    id: p.id_produto, \n    estoque: p.estoque_atual, \n    demanda_dia: p.media_diaria_venda, \n    cobertura_dias: p.dias_de_cobertura, \n    status: p.status_ruptura, \n    preco: p.preco, \n    custo: p.custo,\n    curva: p.classe_abc,\n    margem: p.margem_percentual\n}));\n\nconst contextoDados = `\\n## Produtos Encontrados (${produtosFormatados.length})\\n${JSON.stringify(produtosFormatados.slice(0, 10), null, 2)}`;\n\nreturn {\n    json: {\n        route: parserData.route,\n        original_body: parserData.original_body, \n        payload_string: `# PERGUNTA DO USU√ÅRIO\\n${parserData.original_question}\\n\\n# DADOS REAIS DO SISTEMA SmartOrders${contextoDados}\\n\\n# INSTRU√á√ïES\\nResponda usando APENAS os dados acima. Seja preciso e cite n√∫meros.`, \n        sessionId: parserData.sessionId, \n        intent: parserData.intent,\n        produtos: produtosFormatados,\n        has_data: true, \n        timestamp: new Date().toISOString()\n    }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -464,
                2944
            ],
            "id": "dde2311b-a655-4d1e-bb7c-c530ecf3c087",
            "name": "Construir Contexto RAG2"
        },
        {
            "parameters": {
                "jsCode": "const parserData = $('Parser Analisador1').first().json;\n\nconst intentMessages = {\n    'agradecimento': 'O usu√°rio est√° agradecendo. Responda de forma cordial.', \n    'esclarecimento': 'O usu√°rio quer um esclarecimento. Se precisar de dados, pe√ßa que especifique.', \n    'conversa': 'Continue a conversa de forma natural.', \n    'email_marketing': 'O usu√°rio quer ajuda com email marketing. Ajude a criar um email persuasivo.', \n    'negociacao': 'O usu√°rio quer ajuda com negocia√ß√£o. Forne√ßa estrat√©gias e argumentos.', \n    'relatorio_geral': 'O usu√°rio quer um relat√≥rio. Se n√£o tiver dados, pe√ßa que especifique.',\n    'campanha_estrategica': 'O usu√°rio quer criar uma campanha de liquida√ß√£o. Analise o mix ABC dos produtos selecionados.'\n};\n\nconst instrucao = intentMessages[parserData.intent] || 'Responda de forma natural e conversacional.';\n\nreturn {\n    json: {\n        route: parserData.route,\n        original_body: parserData.original_body, \n        payload_string: `# MENSAGEM DO USU√ÅRIO\\n${parserData.original_question}\\n\\n# CONTEXTO\\nEsta √© uma mensagem conversacional. N√ÉO h√° dados novos do banco.\\n\\n# INSTRU√á√ïES\\n${instrucao}`, \n        sessionId: parserData.sessionId, \n        intent: parserData.intent, \n        has_data: false, \n        timestamp: new Date().toISOString()\n    }\n};"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -464,
                3264
            ],
            "id": "cef11a75-967b-42d4-90fd-a8e772325f9a",
            "name": "Construir Contexto Conversa2"
        },
        {
            "parameters": {
                "model": {
                    "__rl": true,
                    "value": "gpt-4.1-mini",
                    "mode": "list",
                    "cachedResultName": "gpt-4.1-mini"
                },
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
            "typeVersion": 1.2,
            "position": [
                -1600,
                3376
            ],
            "id": "0077f8ba-f560-43c9-9bf4-4f8e24b38858",
            "name": "OpenAI Analisador (3.5)1",
            "credentials": {
                "openAiApi": {
                    "id": "TyEKWHTP8rBl1EHk",
                    "name": "gpt-conta-otto"
                }
            }
        },
        {
            "parameters": {
                "url": "=https://tfhwtejlsybilioiajbx.supabase.co/rest/v1/dados_estoque?tipo_registro=eq.DETALHE{{ $json.filters.search_term ? '&produto_descricao=ilike.*' + $json.filters.search_term.replace(/%/g, '').split(' ').join('*') + '*' : '' }}&limit=100",
                "sendHeaders": true,
                "headerParameters": {
                    "parameters": [
                        {
                            "name": "apikey",
                            "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmaHd0ZWpsc3liaWxpb2lhamJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzM3OTUsImV4cCI6MjA4MDYwOTc5NX0.6Hc1b2h_g7DyGa9fPiOtGx0rL_BWE9xJ-kWBa8jSOrg"
                        },
                        {
                            "name": "Authorization",
                            "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmaHd0ZWpsc3liaWxpb2lhamJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwMzM3OTUsImV4cCI6MjA4MDYwOTc5NX0.6Hc1b2h_g7DyGa9fPiOtGx0rL_BWE9xJ-kWBa8jSOrg"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.2,
            "position": [
                -704,
                2944
            ],
            "id": "99329243-6aa5-4d59-8f0f-a3a1f5610b15",
            "name": "Supabase: Buscar Dados1",
            "alwaysOutputData": true
        },
        {
            "parameters": {
                "modelName": "models/gemini-2.5-pro",
                "options": {}
            },
            "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
            "typeVersion": 1,
            "position": [
                -1504,
                3536
            ],
            "id": "4d81e802-d5f5-432e-888f-3fcbe7c163be",
            "name": "Google Gemini Chat Model1",
            "credentials": {
                "googlePalmApi": {
                    "id": "zHnhnW0LvGSHuNSy",
                    "name": "Metrics"
                }
            }
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "1",
                            "name": "sessionId",
                            "value": "={{ $item(\"0\").$node[\"Webhook\"].json[\"body\"][\"user_id\"] }}",
                            "type": "string"
                        }
                    ]
                },
                "options": {}
            },
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                -1792,
                3104
            ],
            "id": "40e7fbc3-04aa-4e2c-b397-29f62ea9a332",
            "name": "Set Session Marketing2"
        },
        {
            "parameters": {
                "jsCode": "// Pega o body do Webhook\nconst body = $item(\"0\").$node[\"Webhook\"].json.body;\n\n// Fun√ß√£o recursiva para converter qualquer tipo em string\nfunction toStringDeep(value) {\n  if (value === null || value === undefined) {\n    return String(value);\n  }\n\n  if (typeof value === 'object') {\n    // Converte objetos e arrays para JSON string\n    return JSON.stringify(value);\n  }\n\n  // Number, boolean, string, etc\n  return String(value);\n}\n\n// Converte tudo\nconst bodyAsString = toStringDeep(body);\n\nreturn [\n  {\n    json: {\n      body: bodyAsString\n    }\n  }\n];\n"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                -3376,
                3072
            ],
            "id": "39fc9ab1-f277-4d90-b0fd-eff9e4888d32",
            "name": "Code in JavaScript1"
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "b55faa35-738b-41d6-8046-d1c621d2f95e",
                            "leftValue": "={{ $item(\"0\").$node[\"Webhook\"].json[\"body\"][\"action\"] }}",
                            "rightValue": "generate_campaign",
                            "operator": {
                                "type": "string",
                                "operation": "equals",
                                "name": "filter.operator.equals"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                -2752,
                3088
            ],
            "id": "9048d932-9e98-484a-906c-27f321d467f4",
            "name": "If"
        },
        {
            "parameters": {
                "operation": "push",
                "list": "={{ $item(\"0\").$node[\"Webhook\"].json[\"body\"][\"user_id\"] }}",
                "messageData": "={{ JSON.stringify($json)}}",
                "tail": true
            },
            "type": "n8n-nodes-base.redis",
            "typeVersion": 1,
            "position": [
                -2128,
                2880
            ],
            "id": "4df99648-2f1c-4506-b2bf-54cbbc282080",
            "name": "enviar-info",
            "credentials": {
                "redis": {
                    "id": "sffUD8zkNq05YgXj",
                    "name": "IA"
                }
            }
        },
        {
            "parameters": {
                "operation": "get",
                "key": "={{ $item(\"0\").$node[\"Webhook\"].json[\"body\"][\"user_id\"] }}",
                "options": {}
            },
            "type": "n8n-nodes-base.redis",
            "typeVersion": 1,
            "position": [
                416,
                2464
            ],
            "id": "cb987d6e-d01c-431e-93bf-5fec959b2643",
            "name": "enviar-info1",
            "credentials": {
                "redis": {
                    "id": "sffUD8zkNq05YgXj",
                    "name": "IA"
                }
            }
        },
        {
            "parameters": {
                "operation": "delete",
                "key": "={{ $item(\"0\").$node[\"Webhook\"].json[\"body\"][\"user_id\"] }}"
            },
            "type": "n8n-nodes-base.redis",
            "typeVersion": 1,
            "position": [
                -2400,
                2880
            ],
            "id": "900b5ec1-cf28-4367-8859-3528fb74036a",
            "name": "enviar-info2",
            "credentials": {
                "redis": {
                    "id": "sffUD8zkNq05YgXj",
                    "name": "IA"
                }
            }
        },
        {
            "parameters": {
                "operation": "delete",
                "key": "={{ $item(\"0\").$node[\"Webhook\"].json[\"body\"][\"user_id\"] }}"
            },
            "type": "n8n-nodes-base.redis",
            "typeVersion": 1,
            "position": [
                4480,
                2288
            ],
            "id": "ed812c1d-bc07-4b0b-bef0-76764d1235c7",
            "name": "enviar-info3",
            "credentials": {
                "redis": {
                    "id": "sffUD8zkNq05YgXj",
                    "name": "IA"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "try {\n    const output = $input.first().json.output || \n                   $input.first().json.response || '';\n    \n    // O Agente de Marketing retorna texto/markdown, n√£o JSON estruturado\n    // Verificar se √© JSON ou texto\n    let cleanOutput = output\n        .replace(/^```json\\s*/i, '')\n        .replace(/^```\\s*/i, '')\n        .replace(/```\\s*$/i, '')\n        .trim();\n    \n    // Tentar parse como JSON (caso seja resposta estruturada)\n    try {\n        const parsed = JSON.parse(cleanOutput);\n        \n        // Se tem plan, √© resposta do agente estrat√©gico\n        if (parsed.plan || parsed.status) {\n            const plan = parsed.plan || parsed;\n            if (!plan.status) plan.status = 'ajuste_necessario';\n            if (!plan.produtos) plan.produtos = [];\n            if (!plan.alertas) plan.alertas = [];\n            \n            return {\n                success: true,\n                type: 'campaign_plan',\n                plan: plan\n            };\n        }\n        \n        // Se tem channels, √© resposta de ativos\n        if (parsed.channels) {\n            return {\n                success: true,\n                type: 'campaign_assets',\n                channels: parsed.channels\n            };\n        }\n        \n        // JSON gen√©rico\n        return {\n            success: true,\n            type: 'json',\n            data: parsed\n        };\n        \n    } catch (jsonError) {\n        // N√£o √© JSON - √© texto/markdown do agente de marketing\n        // Retornar como resposta de texto\n        return {\n            success: true,\n            type: 'text',\n            message: cleanOutput\n        };\n    }\n    \n} catch (error) {\n    return {\n        success: false,\n        type: 'error',\n        message: 'Erro ao processar resposta: ' + error.message\n    };\n}"
            },
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                720,
                4640
            ],
            "id": "f3fe9562-68a0-41bd-b6cf-43d7dfb83865",
            "name": "Safe Executor Estrat√©gico1"
        },
        {
            "parameters": {
                "promptType": "define",
                "text": "={{ $json.payload_string }}",
                "needsFallback": true,
                "options": {
                    "systemMessage": "# Gerente de Marketing Digital - SmartOrders\n\n## Sua Identidade\nVoc√™ √© um Gerente de Marketing Digital de elite com 25 anos de experi√™ncia em varejo, e-commerce e marketing omnichannel. Fundador de 3 ag√™ncias de marketing premiadas. Especialista em:\n\n- **Estrat√©gia de Campanhas**: Planejamento 360¬∞, mix de m√≠dia, or√ßamento\n- **Copywriting**: T√©cnicas de persuas√£o, gatilhos mentais, storytelling\n- **Performance**: ROI, CAC, LTV, convers√£o, funis de vendas\n- **Branding**: Posicionamento, tom de voz, identidade visual\n- **Digital**: SEO, Social Media, E-mail Marketing, Tr√°fego Pago\n- **Trade Marketing**: PDV, merchandising, promo√ß√µes de varejo\n- **An√°lise de Dados**: M√©tricas, KPIs, dashboards de marketing\n\nVoc√™ j√° liderou campanhas para grandes varejistas de material de constru√ß√£o e home center.\n\n## Sua Miss√£o\nApoiar o setor de marketing do cliente com:\n1. D√∫vidas sobre os ativos gerados pelo sistema\n2. Estrat√©gias de campanha\n3. Reescrita de copies\n4. Consultoria completa de marketing\n\n## ‚ö†Ô∏è IMPORTANTE: SOBRE OS ATIVOS GERADOS\n\nOs ativos criados pelo sistema SmartOrders (copies de WhatsApp, posts de Instagram, briefings visuais) s√£o **GUIAS E REFER√äNCIAS** para o setor de marketing do cliente. Eles servem para:\n\n- Direcionar a cria√ß√£o final de pe√ßas\n- Inspirar o time criativo\n- Agilizar o processo de produ√ß√£o\n- Garantir consist√™ncia estrat√©gica\n\n**Se o cliente reclamar da qualidade ou questionar a arte/copy:**\nExplique gentilmente que esses materiais s√£o bases de trabalho que devem ser refinados pelo time de marketing interno. O sistema gera o conceito estrat√©gico e a dire√ß√£o criativa - a execu√ß√£o final √© responsabilidade da equipe do cliente.\n\n## SUAS CAPACIDADES\n\n### 1. Consultoria de Campanhas\n- Defini√ß√£o de objetivos SMART\n- Escolha de canais de divulga√ß√£o\n- Cronograma de execu√ß√£o\n- Distribui√ß√£o de or√ßamento\n- M√©tricas de acompanhamento\n\n### 2. Reescrita de Copy\nSe o cliente pedir para melhorar uma copy, voc√™ deve:\n- Entender o objetivo (mais urg√™ncia? mais t√©cnico? mais emocional?)\n- Reescrever mantendo a ess√™ncia estrat√©gica\n- Oferecer 2-3 varia√ß√µes\n- Explicar por que cada vers√£o pode funcionar melhor\n\n### 3. Estrat√©gias de Pre√ßo e Promo√ß√£o\n- Ancoragem de pre√ßos\n- Bundles e kits\n- Descontos progressivos\n- Frete gr√°tis como gatilho\n- Upsell e cross-sell\n\n### 4. Calend√°rio Promocional\n- Datas sazonais (Black Friday, Dia das M√£es, etc.)\n- Oportunidades de mercado\n- Frequ√™ncia ideal de promo√ß√µes\n- Evitar \"canibaliza√ß√£o\" de margem\n\n### 5. Canais de Divulga√ß√£o\n**WhatsApp Marketing:**\n- Hor√°rios de pico para disparo\n- Frequ√™ncia adequada (evitar spam)\n- Segmenta√ß√£o de listas\n- Templates que convertem\n\n**Instagram/Redes Sociais:**\n- Formato ideal para cada objetivo\n- Hashtags estrat√©gicas\n- Hor√°rios de maior engajamento\n- Reels vs Stories vs Feed\n\n**PDV/Loja F√≠sica:**\n- Cartazes e banners\n- Pontos focais\n- Comunica√ß√£o de vitrine\n- Cross-merchandising\n\n### 6. M√©tricas e Resultados\n- Como medir sucesso da campanha\n- KPIs por canal\n- ROI esperado por tipo de promo√ß√£o\n- Benchmarks do setor de material de constru√ß√£o\n\n## TOM DE VOZ\n- Profissional mas acess√≠vel\n- Did√°tico sem ser condescendente\n- Proativo em sugest√µes\n- Baseado em dados e experi√™ncia\n\n## EXEMPLOS DE INTERA√á√ÉO\n\n### Usu√°rio: \"A copy do WhatsApp ficou muito simples, pode melhorar?\"\n\n**Resposta:**\n\"Claro! Lembre que a copy gerada √© uma base de trabalho. Posso te ajudar a refinar. Qual dire√ß√£o voc√™ prefere?\n\n**Op√ß√£o A - Mais Urgente:**\nüö® ALERTA DE PRE√áO! S√≥ restam 23 unidades de Cimento CP2 por R$ 28,90! Quem n√£o comprar hoje, paga R$ 45 amanh√£. Responda J√Å QUERO!\n\n**Op√ß√£o B - Mais T√©cnica:**\nüë∑ Profissional, temos Cimento CP2-32 (NBR 16697) por R$ 28,90/saca. Resist√™ncia 32MPa aos 28 dias. Estoque limitado. Precisa? Manda OI.\n\n**Op√ß√£o C - Mais Emocional:**\nüè† Seu sonho de reformar a casa come√ßa aqui! Cimento por apenas R$ 28,90. Esse pre√ßo √© pra quem REALMENTE quer transformar seu lar. Vem com a gente?\n\nQual estilo combina mais com seu p√∫blico?\"\n\n---\n\n### Usu√°rio: \"Por que voc√™s geraram essa arte t√£o b√°sica?\"\n\n**Resposta:**\n\"Entendo sua preocupa√ß√£o! √â importante esclarecer: os ativos gerados pelo SmartOrders s√£o **briefings estrat√©gicos e direcionais**, n√£o pe√ßas finais.\n\nFunciona assim:\n1. O sistema analisa seus produtos e gera a estrat√©gia ideal\n2. Cria um GUIA com headline, desconto, cores sugeridas\n3. Seu time de marketing/designer usa isso como base para a arte final\n\nPense como um 'roteiro de campanha' - voc√™ economiza tempo de planejamento e foca na execu√ß√£o.\n\nSe precisar, posso te ajudar a refinar o briefing com mais detalhes para seu designer! O que voc√™ gostaria de ajustar?\"\n\n---\n\n### Usu√°rio: \"Qual melhor hor√°rio para enviar WhatsApp de promo√ß√£o?\"\n\n**Resposta:**\n\"√ìtima pergunta! Para varejo de material de constru√ß√£o, os melhores hor√°rios s√£o:\n\nüì± **WhatsApp - Hor√°rios de Pico:**\n- **10h-10h30** ‚Üí Profissionais j√° no canteiro, conferem celular no caf√©\n- **12h-13h** ‚Üí Hor√°rio de almo√ßo\n- **18h-19h** ‚Üí Fim de expediente, maior engajamento\n\nüìÖ **Melhores Dias:**\n- **Ter√ßa a Quinta** ‚Üí Maior taxa de resposta\n- **S√°bado 8h-10h** ‚Üí Clientes residenciais planejando compras\n\n‚ö†Ô∏è **Evite:**\n- Segunda-feira cedo (muitas mensagens acumuladas)\n- Sexta ap√≥s 16h (foco j√° no fim de semana)\n- Domingo (baixa taxa de resposta)\n\nüí° **Dica Extra:** Fa√ßa um follow-up 24h depois para quem n√£o respondeu. Converte at√© 15% a mais!\n\nQuer que eu crie uma copy espec√≠fica para cada hor√°rio?\"\n\n## FORMATO DE RESPOSTA\n- Use markdown para organizar (t√≠tulos, listas, negrito)\n- Seja pr√°tico e acion√°vel\n- Ofere√ßa alternativas quando aplic√°vel\n- Termine com uma pergunta ou pr√≥ximo passo\n\n## REGRA FINAL\nVoc√™ √© o consultor de marketing que todo cliente gostaria de ter. Seja estrat√©gico, did√°tico e sempre focado em resultados. Ajude o cliente a extrair o m√°ximo valor das campanhas."
                }
            },
            "type": "@n8n/n8n-nodes-langchain.agent",
            "typeVersion": 2.2,
            "position": [
                304,
                4640
            ],
            "id": "0121e945-9adf-45a4-bafd-5212d9899344",
            "name": "Agente de marketing"
        },
        {
            "parameters": {
                "contextWindowLength": 100
            },
            "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
            "typeVersion": 1.5,
            "position": [
                -1344,
                3504
            ],
            "id": "40486907-6f0c-493c-bc44-0b2ef3e679f6",
            "name": "Redis Chat Memory1",
            "credentials": {
                "redis": {
                    "id": "tNmhklhXVFMW6hRR",
                    "name": "Comercial"
                }
            }
        },
        {
            "parameters": {
                "contextWindowLength": 100
            },
            "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
            "typeVersion": 1.5,
            "position": [
                2432,
                3664
            ],
            "id": "0c48baab-a017-4bdf-8f78-537c70fbf676",
            "name": "Redis Chat Memory",
            "credentials": {
                "redis": {
                    "id": "tNmhklhXVFMW6hRR",
                    "name": "Comercial"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "strict",
                        "version": 2
                    },
                    "conditions": [
                        {
                            "id": "4377eeca-a534-4ba4-9460-d7d3a4cfa439",
                            "leftValue": "={{ $item(\"0\").$node[\"Webhook\"].json[\"body\"][\"message\"] }}",
                            "rightValue": "/reset",
                            "operator": {
                                "type": "string",
                                "operation": "equals",
                                "name": "filter.operator.equals"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                -3104,
                3072
            ],
            "id": "e082f225-0de1-4015-bee8-cdbe0a4ca56d",
            "name": "If1"
        },
        {
            "parameters": {
                "operation": "delete",
                "key": "={{ $item(\"0\").$node[\"Webhook\"].json[\"body\"][\"user_id\"] }}"
            },
            "type": "n8n-nodes-base.redis",
            "typeVersion": 1,
            "position": [
                -2752,
                2832
            ],
            "id": "64742137-7ecf-4bdd-baf8-f9155d6ba0d4",
            "name": "Apagar historico",
            "credentials": {
                "redis": {
                    "id": "tNmhklhXVFMW6hRR",
                    "name": "Comercial"
                }
            }
        }
    ],
    "connections": {
        "Set Session Marketing1": {
            "main": [
                [
                    {
                        "node": "Agente Instagram1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Agente Instagram1": {
            "main": [
                [
                    {
                        "node": "Parser Instagram1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Agente Visual Merchandising1": {
            "main": [
                [
                    {
                        "node": "Parser Visual1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parser Instagram1": {
            "main": [
                [
                    {
                        "node": "Gemini Panfleto1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parser Visual1": {
            "main": [
                [
                    {
                        "node": "Gemini Cartaz1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parser CRM1": {
            "main": [
                [
                    {
                        "node": "Set Session Visual1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Gemini Panfleto1": {
            "main": [
                [
                    {
                        "node": "Safe Image Panfleto1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Gemini Cartaz1": {
            "main": [
                [
                    {
                        "node": "Safe Image Cartaz1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Safe Image Panfleto1": {
            "main": [
                [
                    {
                        "node": "Set Session CRM1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Safe Image Cartaz1": {
            "main": [
                [
                    {
                        "node": "Merge Marketing Results1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Marketing Results1": {
            "main": [
                [
                    {
                        "node": "Structure Response1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Structure Response1": {
            "main": [
                [
                    {
                        "node": "Respond Marketing1",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "enviar-info3",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set Session CRM1": {
            "main": [
                [
                    {
                        "node": "Agente CRM2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set Session Visual1": {
            "main": [
                [
                    {
                        "node": "Agente Visual Merchandising1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Agente CRM2": {
            "main": [
                [
                    {
                        "node": "Parser CRM1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch Router2": {
            "main": [
                [
                    {
                        "node": "enviar-info1",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Agente Estoque (Sales Sniper)2",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Agente Compras2",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Agente Email2",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Agente Relat√≥rios2",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Agente Negocia√ß√£o2",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Agente Estrat√©gico Campanhas",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Agente de marketing",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Agente Compras2": {
            "main": [
                [
                    {
                        "node": "Safe Executor Compra2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Agente Estoque (Sales Sniper)2": {
            "main": [
                [
                    {
                        "node": "Safe Executor Estoque2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Safe Executor Estoque2": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook4",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Safe Executor Compra2": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook4",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Agente Email2": {
            "main": [
                [
                    {
                        "node": "Safe Executor Email2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Agente Relat√≥rios2": {
            "main": [
                [
                    {
                        "node": "Safe Executor Relatorio2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Agente Negocia√ß√£o2": {
            "main": [
                [
                    {
                        "node": "Safe Executor Negociacao2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Safe Executor Email2": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook4",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Safe Executor Relatorio2": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook4",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Safe Executor Negociacao2": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook4",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenAI Chat Model4": {
            "ai_languageModel": [
                [
                    {
                        "node": "Agente Compras2",
                        "type": "ai_languageModel",
                        "index": 0
                    },
                    {
                        "node": "Agente Estoque (Sales Sniper)2",
                        "type": "ai_languageModel",
                        "index": 0
                    },
                    {
                        "node": "Agente Email2",
                        "type": "ai_languageModel",
                        "index": 0
                    },
                    {
                        "node": "Agente Relat√≥rios2",
                        "type": "ai_languageModel",
                        "index": 0
                    },
                    {
                        "node": "Agente Negocia√ß√£o2",
                        "type": "ai_languageModel",
                        "index": 0
                    },
                    {
                        "node": "Agente Instagram1",
                        "type": "ai_languageModel",
                        "index": 0
                    },
                    {
                        "node": "Agente CRM2",
                        "type": "ai_languageModel",
                        "index": 0
                    },
                    {
                        "node": "Agente Visual Merchandising1",
                        "type": "ai_languageModel",
                        "index": 0
                    },
                    {
                        "node": "Agente Estrat√©gico Campanhas",
                        "type": "ai_languageModel",
                        "index": 0
                    },
                    {
                        "node": "Agente de marketing",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Google Gemini Chat Model6": {
            "ai_languageModel": [
                [
                    {
                        "node": "Agente Compras2",
                        "type": "ai_languageModel",
                        "index": 1
                    },
                    {
                        "node": "Agente Estoque (Sales Sniper)2",
                        "type": "ai_languageModel",
                        "index": 1
                    },
                    {
                        "node": "Agente Email2",
                        "type": "ai_languageModel",
                        "index": 1
                    },
                    {
                        "node": "Agente Relat√≥rios2",
                        "type": "ai_languageModel",
                        "index": 1
                    },
                    {
                        "node": "Agente Negocia√ß√£o2",
                        "type": "ai_languageModel",
                        "index": 1
                    },
                    {
                        "node": "Agente Instagram1",
                        "type": "ai_languageModel",
                        "index": 1
                    },
                    {
                        "node": "Agente CRM2",
                        "type": "ai_languageModel",
                        "index": 1
                    },
                    {
                        "node": "Agente Visual Merchandising1",
                        "type": "ai_languageModel",
                        "index": 1
                    },
                    {
                        "node": "Agente Estrat√©gico Campanhas",
                        "type": "ai_languageModel",
                        "index": 1
                    },
                    {
                        "node": "Agente de marketing",
                        "type": "ai_languageModel",
                        "index": 1
                    }
                ]
            ]
        },
        "Agente Estrat√©gico Campanhas": {
            "main": [
                [
                    {
                        "node": "Safe Executor Estrat√©gico",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Safe Executor Estrat√©gico": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Webhook": {
            "main": [
                [
                    {
                        "node": "Code in JavaScript1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Agente Analisador1": {
            "main": [
                [
                    {
                        "node": "Parser Analisador1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parser Analisador1": {
            "main": [
                [
                    {
                        "node": "Precisa RAG?2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Precisa RAG?2": {
            "main": [
                [
                    {
                        "node": "Supabase: Buscar Dados1",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Construir Contexto Conversa2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Construir Contexto RAG2": {
            "main": [
                [
                    {
                        "node": "Switch Router2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Construir Contexto Conversa2": {
            "main": [
                [
                    {
                        "node": "Switch Router2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "OpenAI Analisador (3.5)1": {
            "ai_languageModel": [
                [
                    {
                        "node": "Agente Analisador1",
                        "type": "ai_languageModel",
                        "index": 0
                    }
                ]
            ]
        },
        "Supabase: Buscar Dados1": {
            "main": [
                [
                    {
                        "node": "Construir Contexto RAG2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Google Gemini Chat Model1": {
            "ai_languageModel": [
                [
                    {
                        "node": "Agente Analisador1",
                        "type": "ai_languageModel",
                        "index": 1
                    }
                ]
            ]
        },
        "Set Session Marketing2": {
            "main": [
                [
                    {
                        "node": "Agente Analisador1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Code in JavaScript1": {
            "main": [
                [
                    {
                        "node": "If1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "If": {
            "main": [
                [
                    {
                        "node": "enviar-info2",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Set Session Marketing2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "enviar-info": {
            "main": [
                [
                    {
                        "node": "Set Session Marketing2",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "enviar-info1": {
            "main": [
                [
                    {
                        "node": "Set Session Marketing1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "enviar-info2": {
            "main": [
                [
                    {
                        "node": "enviar-info",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Safe Executor Estrat√©gico1": {
            "main": [
                [
                    {
                        "node": "Respond to Webhook",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Agente de marketing": {
            "main": [
                [
                    {
                        "node": "Safe Executor Estrat√©gico1",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Redis Chat Memory1": {
            "ai_memory": [
                [
                    {
                        "node": "Agente Analisador1",
                        "type": "ai_memory",
                        "index": 0
                    }
                ]
            ]
        },
        "Redis Chat Memory": {
            "ai_memory": [
                [
                    {
                        "node": "Agente Visual Merchandising1",
                        "type": "ai_memory",
                        "index": 0
                    },
                    {
                        "node": "Agente CRM2",
                        "type": "ai_memory",
                        "index": 0
                    },
                    {
                        "node": "Agente Instagram1",
                        "type": "ai_memory",
                        "index": 0
                    },
                    {
                        "node": "Agente de marketing",
                        "type": "ai_memory",
                        "index": 0
                    },
                    {
                        "node": "Agente Estrat√©gico Campanhas",
                        "type": "ai_memory",
                        "index": 0
                    },
                    {
                        "node": "Agente Negocia√ß√£o2",
                        "type": "ai_memory",
                        "index": 0
                    },
                    {
                        "node": "Agente Relat√≥rios2",
                        "type": "ai_memory",
                        "index": 0
                    },
                    {
                        "node": "Agente Email2",
                        "type": "ai_memory",
                        "index": 0
                    },
                    {
                        "node": "Agente Compras2",
                        "type": "ai_memory",
                        "index": 0
                    },
                    {
                        "node": "Agente Estoque (Sales Sniper)2",
                        "type": "ai_memory",
                        "index": 0
                    }
                ]
            ]
        },
        "If1": {
            "main": [
                [
                    {
                        "node": "Apagar historico",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "If",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {
        "Webhook": [
            {
                "headers": {
                    "host": "webhook.aiensed.com",
                    "user-agent": "node",
                    "content-length": "300",
                    "accept": "*/*",
                    "accept-encoding": "br, gzip, deflate",
                    "accept-language": "*",
                    "content-type": "application/json",
                    "sec-fetch-mode": "cors",
                    "x-forwarded-for": "44.211.213.10",
                    "x-forwarded-host": "webhook.aiensed.com",
                    "x-forwarded-port": "443",
                    "x-forwarded-proto": "https",
                    "x-forwarded-server": "87b9a0850ae6",
                    "x-real-ip": "44.211.213.10",
                    "x-vercel-id": "gru1::z69kv-1768248559222-51b7632e278f"
                },
                "params": {},
                "query": {},
                "body": {
                    "action": "criar_plano_acao",
                    "alertType": "mortos",
                    "alertLabel": "Produtos Mortos",
                    "totalQuantity": 2710,
                    "totalValue": 493643.6899999998,
                    "message": "Preciso de um plano de a√ß√£o para produtos mortos. Tenho 2.710 itens parados totalizando R$¬†493.643,69.",
                    "user_id": "65ba6d49-7ad2-412a-81d0-586ee301cbe8"
                },
                "webhookUrl": "https://webhook.aiensed.com/webhook/estoque",
                "executionMode": "production"
            }
        ]
    },
    "meta": {
        "templateCredsSetupCompleted": true,
        "instanceId": "27e203b8d0ac73891032fa9f58c8cd38e53bbb56abd519cce7d9751638aae6d0"
    }
}