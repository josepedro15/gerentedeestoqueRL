{
  "name": "Gerente de Estoque - API SIGER",
  "nodes": [
    {
      "parameters": {
        "path": "gerente-estoque",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        1600,
        300
      ],
      "id": "webhook-gerente-estoque",
      "name": "Webhook Gerente Estoque",
      "webhookId": "gerente-estoque-001"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// CONFIGURAÃ‡Ã•ES DO WORKFLOW\n// =============================================\n\nconst hoje = new Date();\nconst brasil = new Date(hoje.getTime() - (3 * 60 * 60 * 1000)); // UTC-3\n\nfunction formatDate(date) {\n    const d = date.getDate().toString().padStart(2, '0');\n    const m = (date.getMonth() + 1).toString().padStart(2, '0');\n    const y = date.getFullYear();\n    return `${d}/${m}/${y}`;\n}\n\nfunction subtractDays(date, days) {\n    const result = new Date(date);\n    result.setDate(result.getDate() - days);\n    return result;\n}\n\nconst data_fim = formatDate(brasil);\nconst data_inicio_60d = formatDate(subtractDays(brasil, 60));\nconst data_inicio_30d = formatDate(subtractDays(brasil, 30));\n\nreturn [{\n    json: {\n        api_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwYXlsb2FkIjp7ImNvZGlnb0NsaWVudGUiOjM0NDgsInNlcXVlbmNpYUluc3RhbGFjYW8iOjAsImNvbnRleHRvIjoiUk9MQU1BSVMgLSBJQSJ9fQ.Opp3IOWGIn5JEYk7x3evpkmAU5nMYPHSQKSa2FylSfg',\n        organization: 'ROL',\n        data_fim: data_fim,\n        data_inicio_60d: data_inicio_60d,\n        data_inicio_30d: data_inicio_30d,\n        cfops_venda: [5102, 5405, 6102, 6405]\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1840,
        300
      ],
      "id": "config-node",
      "name": "Config"
    },
    {
      "parameters": {
        "url": "=https://api.siger.com.br/api/v1/get-list?organization={{ $json.organization }}&entity=accumulatedStock&size=5000&fields=productID,product.code,product.description,product.salePrice,product.acquisitionCost,product.stockMinimumQuantity,product.unitMeasure.unit,physicalQuantity,reservedQuantity,stockLocation.description",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_token }}"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2120,
        180
      ],
      "id": "get-produtos",
      "name": "GET Estoque"
    },
    {
      "parameters": {
        "url": "=https://api.siger.com.br/api/v1/get-list?organization={{ $json.organization }}&entity=invoiceItems&size=10000&fields=productID,product.code,product.description,quantity,price,invoice.billingDate,invoice.positionInvoice,cfopCode.cfopCode&search=invoice.billingDate GTE \"{{ $json.data_inicio_60d }}\" AND invoice.billingDate LTE \"{{ $json.data_fim }}\" AND invoice.positionInvoice EQ 3",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json.api_token }}"
            }
          ]
        },
        "options": {
          "timeout": 120000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2120,
        420
      ],
      "id": "get-vendas-60d",
      "name": "GET Vendas 60d"
    },
    {
      "parameters": {
        "numberInputs": 2
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        2400,
        300
      ],
      "id": "merge-dados",
      "name": "Merge Dados"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// GERENTE DE ESTOQUE - PROCESSAMENTO COMPLETO\n// Replica todos os cÃ¡lculos do SQL original\n// Usando entity: accumulatedStock\n// =============================================\n\nconst config = $('Config').first().json;\nconst estoqueRaw = $('GET Estoque').first().json.content || [];\nconst vendasRaw = $('GET Vendas 60d').first().json.content || [];\n\n// CFOPs de venda vÃ¡lidos\nconst CFOPS_VENDA = config.cfops_venda || [5102, 5405, 6102, 6405];\n\n// =============================================\n// FUNÃ‡Ã•ES AUXILIARES\n// =============================================\n\nfunction parseDate(str) {\n    if (!str) return null;\n    const [d, m, y] = str.split('/').map(Number);\n    return new Date(y, m - 1, d);\n}\n\nfunction getHojeBrasil() {\n    const now = new Date();\n    const brasil = new Date(now.getTime() - (3 * 60 * 60 * 1000));\n    brasil.setHours(0, 0, 0, 0);\n    return brasil;\n}\n\nfunction daysDiff(date1, date2) {\n    const d1 = new Date(date1);\n    const d2 = new Date(date2);\n    d1.setHours(0, 0, 0, 0);\n    d2.setHours(0, 0, 0, 0);\n    return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));\n}\n\nfunction round(value, decimals = 2) {\n    return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals);\n}\n\nconst hoje = getHojeBrasil();\nconst data30dAtras = new Date(hoje);\ndata30dAtras.setDate(data30dAtras.getDate() - 30);\n\n// =============================================\n// 1. CRIAR MAPA DE PRODUTOS COM ESTOQUE\n// (usando accumulatedStock)\n// =============================================\n\nconst produtos = {};\n\nfor (const item of estoqueRaw) {\n    const id = item.product?.code || item.productID;\n    if (!id) continue;\n    \n    // Estoque livre = fÃ­sico - reservado\n    const estoqueAtual = (Number(item.physicalQuantity) || 0) - (Number(item.reservedQuantity) || 0);\n    \n    // Agrupar por produto (pode ter mÃºltiplos locais)\n    if (!produtos[id]) {\n        produtos[id] = {\n            id_produto: id,\n            produto_descricao: (item.product?.description || '').trim(),\n            estoque_atual: 0,\n            preco: Number(item.product?.salePrice) || 0,\n            custo: Number(item.product?.acquisitionCost) || 0,\n            unidade: item.product?.unitMeasure?.unit || 'UN',\n            estoque_minimo: Number(item.product?.stockMinimumQuantity) || 0,\n            // Campos de vendas (serÃ£o preenchidos)\n            qtd_vendida_60d: 0,\n            faturamento_60d: 0,\n            ultima_venda: null,\n            vendas_30d_atual: 0,\n            vendas_30d_anterior: 0,\n            faturamento_30d_atual: 0,\n            faturamento_30d_anterior: 0\n        };\n    }\n    \n    // Somar estoque de todos os locais\n    produtos[id].estoque_atual += estoqueAtual;\n}\n\n// =============================================\n// 2. PROCESSAR VENDAS E AGREGAR POR PRODUTO\n// =============================================\n\nfor (const v of vendasRaw) {\n    const cfop = Number(String(v.cfopCode?.cfopCode || v.cfopCode || '').replace(/[^\\d]/g, ''));\n    if (!CFOPS_VENDA.includes(cfop)) continue;\n    \n    const prodId = v.product?.code || v.productID;\n    if (!prodId) continue;\n    \n    const quantidade = Math.abs(Number(v.quantity) || 0);\n    const preco = Number(v.price) || 0;\n    const faturamento = quantidade * preco;\n    const dataVenda = parseDate(v.invoice?.billingDate);\n    \n    // Criar produto se nÃ£o existir (produto sem estoque mas com venda)\n    if (!produtos[prodId]) {\n        produtos[prodId] = {\n            id_produto: prodId,\n            produto_descricao: (v.product?.description || 'SEM NOME').trim(),\n            estoque_atual: 0,\n            preco: preco,\n            custo: 0,\n            unidade: 'UN',\n            estoque_minimo: 0,\n            qtd_vendida_60d: 0,\n            faturamento_60d: 0,\n            ultima_venda: null,\n            vendas_30d_atual: 0,\n            vendas_30d_anterior: 0,\n            faturamento_30d_atual: 0,\n            faturamento_30d_anterior: 0\n        };\n    }\n    \n    const prod = produtos[prodId];\n    \n    // Acumular vendas 60 dias\n    prod.qtd_vendida_60d += quantidade;\n    prod.faturamento_60d += faturamento;\n    \n    // Ãšltima venda\n    if (dataVenda && (!prod.ultima_venda || dataVenda > prod.ultima_venda)) {\n        prod.ultima_venda = dataVenda;\n    }\n    \n    // Separar em perÃ­odos (30d atual vs 30d anterior)\n    if (dataVenda && dataVenda >= data30dAtras) {\n        prod.vendas_30d_atual += quantidade;\n        prod.faturamento_30d_atual += faturamento;\n    } else if (dataVenda) {\n        prod.vendas_30d_anterior += quantidade;\n        prod.faturamento_30d_anterior += faturamento;\n    }\n}\n\n// =============================================\n// 3. CALCULAR CURVA ABC\n// =============================================\n\nconst produtosArray = Object.values(produtos);\n\n// Ordenar por faturamento DESC para ABC\nconst produtosOrdenados = [...produtosArray]\n    .filter(p => p.faturamento_60d > 0)\n    .sort((a, b) => b.faturamento_60d - a.faturamento_60d);\n\nconst faturamentoTotal = produtosOrdenados.reduce((sum, p) => sum + p.faturamento_60d, 0);\n\nlet faturamentoAcumulado = 0;\nfor (const p of produtosOrdenados) {\n    faturamentoAcumulado += p.faturamento_60d;\n    const percentualAcumulado = (faturamentoAcumulado / faturamentoTotal) * 100;\n    \n    p.percentual_acumulado_abc = round(percentualAcumulado);\n    \n    if (percentualAcumulado <= 80) {\n        p.classe_abc = 'A';\n    } else if (percentualAcumulado <= 95) {\n        p.classe_abc = 'B';\n    } else {\n        p.classe_abc = 'C';\n    }\n}\n\n// Produtos sem venda = Classe C\nfor (const p of produtosArray) {\n    if (!p.classe_abc) {\n        p.classe_abc = 'C';\n        p.percentual_acumulado_abc = 100;\n    }\n}\n\n// =============================================\n// 4. CALCULAR TODOS OS INDICADORES\n// =============================================\n\nfor (const p of produtosArray) {\n    // MARGEM\n    p.margem_unitaria = round(p.preco - p.custo);\n    p.margem_percentual = p.preco > 0 \n        ? round(((p.preco - p.custo) / p.preco) * 100) \n        : 0;\n    \n    // LUCRO 60 DIAS\n    p.lucro_60d = round(p.margem_unitaria * p.qtd_vendida_60d);\n    \n    // MÃ‰DIA DIÃRIA\n    p.media_diaria_venda = round(p.qtd_vendida_60d / 60);\n    \n    // DIAS DE COBERTURA\n    if (p.qtd_vendida_60d === 0) {\n        p.dias_de_cobertura = 999;\n    } else {\n        p.dias_de_cobertura = round(p.estoque_atual / p.media_diaria_venda, 1);\n    }\n    \n    // STATUS DE RUPTURA\n    if (p.estoque_atual === 0 && p.qtd_vendida_60d > 0) {\n        p.status_ruptura = 'ðŸ”´ Ruptura';\n    } else if (p.qtd_vendida_60d === 0 || p.dias_de_cobertura > 90) {\n        p.status_ruptura = 'âšª Excesso';\n    } else if (p.dias_de_cobertura < 7) {\n        p.status_ruptura = 'ðŸŸ  CrÃ­tico';\n    } else if (p.dias_de_cobertura <= 15) {\n        p.status_ruptura = 'ðŸŸ¡ AtenÃ§Ã£o';\n    } else if (p.dias_de_cobertura <= 90) {\n        p.status_ruptura = 'ðŸŸ¢ SaudÃ¡vel';\n    } else {\n        p.status_ruptura = 'Status Desconhecido';\n    }\n    \n    // GIRO MENSAL\n    p.giro_mensal = p.estoque_atual > 0\n        ? round((p.qtd_vendida_60d / 2) / p.estoque_atual)\n        : 0;\n    \n    // VALOR ESTOQUE\n    p.valor_estoque_custo = round(p.estoque_atual * p.custo);\n    p.valor_estoque_venda = round(p.estoque_atual * p.preco);\n    \n    // SUGESTÃƒO DE COMPRA (para 60 dias de cobertura)\n    if (p.qtd_vendida_60d === 0) {\n        p.sugestao_compra_60d = 0;\n    } else {\n        p.sugestao_compra_60d = Math.max(0, Math.round((p.media_diaria_venda * 60) - p.estoque_atual));\n    }\n    \n    // TENDÃŠNCIA\n    if (p.vendas_30d_anterior === 0 && p.vendas_30d_atual > 0) {\n        p.tendencia = 'ðŸ“ˆ Novo';\n        p.variacao_percentual = 0;\n    } else if (p.vendas_30d_anterior === 0) {\n        p.tendencia = 'âž¡ï¸ Sem histÃ³rico';\n        p.variacao_percentual = 0;\n    } else {\n        p.variacao_percentual = round(((p.vendas_30d_atual - p.vendas_30d_anterior) / p.vendas_30d_anterior) * 100, 1);\n        \n        if (p.vendas_30d_atual > p.vendas_30d_anterior * 1.1) {\n            p.tendencia = 'ðŸ“ˆ Subindo';\n        } else if (p.vendas_30d_atual < p.vendas_30d_anterior * 0.9) {\n            p.tendencia = 'ðŸ“‰ Caindo';\n        } else {\n            p.tendencia = 'âž¡ï¸ EstÃ¡vel';\n        }\n    }\n    \n    // DIAS SEM VENDA\n    if (p.ultima_venda) {\n        p.dias_sem_venda = daysDiff(p.ultima_venda, hoje);\n        p.ultima_venda_formatada = p.ultima_venda.toLocaleDateString('pt-BR');\n    } else {\n        p.dias_sem_venda = 999;\n        p.ultima_venda_formatada = null;\n    }\n    \n    // PRIORIDADE DE COMPRA\n    const isRuptura = p.estoque_atual === 0 && p.qtd_vendida_60d > 0;\n    const isCritico = p.dias_de_cobertura < 7;\n    const isAtencao = p.dias_de_cobertura <= 15;\n    \n    if (isRuptura && p.classe_abc === 'A') {\n        p.prioridade_compra = '1-URGENTE';\n    } else if ((isRuptura && p.classe_abc === 'B') || (isCritico && p.classe_abc === 'A')) {\n        p.prioridade_compra = '2-ALTA';\n    } else if (isCritico) {\n        p.prioridade_compra = '3-MEDIA';\n    } else if ((isRuptura && p.classe_abc === 'C') || isAtencao) {\n        p.prioridade_compra = '4-BAIXA';\n    } else {\n        p.prioridade_compra = '5-NENHUMA';\n    }\n    \n    // ALERTA DE ESTOQUE\n    if (p.qtd_vendida_60d === 0 && p.estoque_atual > 0) {\n        p.alerta_estoque = 'ðŸ’€ MORTO';\n    } else if (p.dias_de_cobertura > 365 && p.classe_abc === 'C') {\n        p.alerta_estoque = 'ðŸš¨ LIQUIDAR';\n    } else if (p.dias_de_cobertura > 365) {\n        p.alerta_estoque = 'âš ï¸ AVALIAR';\n    } else if (p.dias_de_cobertura > 180) {\n        p.alerta_estoque = 'ðŸ“‹ ATENÃ‡ÃƒO';\n    } else {\n        p.alerta_estoque = 'âœ… OK';\n    }\n}\n\n// =============================================\n// 5. GERAR SUMÃRIO POR STATUS\n// =============================================\n\nconst sumarioPorStatus = {};\nfor (const p of produtosArray) {\n    const status = p.status_ruptura;\n    if (!sumarioPorStatus[status]) {\n        sumarioPorStatus[status] = {\n            status_ruptura: status,\n            total_produtos: 0,\n            total_valor_estoque: 0,\n            total_faturamento: 0\n        };\n    }\n    sumarioPorStatus[status].total_produtos += 1;\n    sumarioPorStatus[status].total_valor_estoque += p.valor_estoque_custo;\n    sumarioPorStatus[status].total_faturamento += p.faturamento_60d;\n}\n\n// Ordenar sumÃ¡rio\nconst ordemStatus = ['ðŸ”´ Ruptura', 'ðŸŸ  CrÃ­tico', 'ðŸŸ¡ AtenÃ§Ã£o', 'ðŸŸ¢ SaudÃ¡vel', 'âšª Excesso'];\nconst sumarioArray = ordemStatus\n    .filter(s => sumarioPorStatus[s])\n    .map(s => ({\n        ...sumarioPorStatus[s],\n        total_valor_estoque: round(sumarioPorStatus[s].total_valor_estoque),\n        total_faturamento: round(sumarioPorStatus[s].total_faturamento)\n    }));\n\n// =============================================\n// 6. RANKING POR STATUS E ORDENAÃ‡ÃƒO\n// =============================================\n\n// Ordenar produtos por status, prioridade, dias cobertura, faturamento\nconst produtosOrdenadosFinal = [...produtosArray].sort((a, b) => {\n    // Status\n    const statusA = ordemStatus.indexOf(a.status_ruptura);\n    const statusB = ordemStatus.indexOf(b.status_ruptura);\n    if (statusA !== statusB) return statusA - statusB;\n    \n    // Prioridade\n    const prioridadeA = parseInt(a.prioridade_compra.charAt(0)) || 5;\n    const prioridadeB = parseInt(b.prioridade_compra.charAt(0)) || 5;\n    if (prioridadeA !== prioridadeB) return prioridadeA - prioridadeB;\n    \n    // Dias de cobertura (menor primeiro)\n    if (a.dias_de_cobertura !== b.dias_de_cobertura) {\n        return a.dias_de_cobertura - b.dias_de_cobertura;\n    }\n    \n    // Faturamento (maior primeiro)\n    return b.faturamento_60d - a.faturamento_60d;\n});\n\n// Adicionar rank por status\nconst rankPorStatus = {};\nfor (const p of produtosOrdenadosFinal) {\n    const status = p.status_ruptura;\n    if (!rankPorStatus[status]) rankPorStatus[status] = 0;\n    rankPorStatus[status]++;\n    p.rank_por_status = rankPorStatus[status];\n}\n\n// =============================================\n// 7. TOTAIS GERAIS\n// =============================================\n\nconst totalGeral = {\n    total_produtos: produtosArray.length,\n    total_com_estoque: produtosArray.filter(p => p.estoque_atual > 0).length,\n    total_com_venda: produtosArray.filter(p => p.qtd_vendida_60d > 0).length,\n    valor_estoque_custo: round(produtosArray.reduce((s, p) => s + p.valor_estoque_custo, 0)),\n    valor_estoque_venda: round(produtosArray.reduce((s, p) => s + p.valor_estoque_venda, 0)),\n    faturamento_60d: round(produtosArray.reduce((s, p) => s + p.faturamento_60d, 0)),\n    lucro_60d: round(produtosArray.reduce((s, p) => s + p.lucro_60d, 0)),\n    qtd_ruptura: produtosArray.filter(p => p.status_ruptura === 'ðŸ”´ Ruptura').length,\n    qtd_critico: produtosArray.filter(p => p.status_ruptura === 'ðŸŸ  CrÃ­tico').length,\n    qtd_atencao: produtosArray.filter(p => p.status_ruptura === 'ðŸŸ¡ AtenÃ§Ã£o').length,\n    qtd_saudavel: produtosArray.filter(p => p.status_ruptura === 'ðŸŸ¢ SaudÃ¡vel').length,\n    qtd_excesso: produtosArray.filter(p => p.status_ruptura === 'âšª Excesso').length\n};\n\n// =============================================\n// 8. RESULTADO FINAL\n// =============================================\n\nreturn [{\n    json: {\n        periodo: {\n            inicio: config.data_inicio_60d,\n            fim: config.data_fim,\n            gerado_em: new Date().toLocaleString('pt-BR')\n        },\n        resumo: totalGeral,\n        sumario_por_status: sumarioArray,\n        produtos: produtosOrdenadosFinal.map(p => ({\n            tipo_registro: 'DETALHE',\n            rank_por_status: p.rank_por_status,\n            id_produto: p.id_produto,\n            produto_descricao: p.produto_descricao,\n            unidade: p.unidade,\n            estoque_atual: p.estoque_atual,\n            estoque_minimo: p.estoque_minimo,\n            preco: p.preco,\n            custo: p.custo,\n            margem_unitaria: p.margem_unitaria,\n            margem_percentual: p.margem_percentual,\n            qtd_vendida_60d: p.qtd_vendida_60d,\n            faturamento_60d: p.faturamento_60d,\n            lucro_60d: p.lucro_60d,\n            media_diaria_venda: p.media_diaria_venda,\n            dias_de_cobertura: p.dias_de_cobertura,\n            status_ruptura: p.status_ruptura,\n            classe_abc: p.classe_abc,\n            percentual_acumulado_abc: p.percentual_acumulado_abc,\n            giro_mensal: p.giro_mensal,\n            valor_estoque_custo: p.valor_estoque_custo,\n            valor_estoque_venda: p.valor_estoque_venda,\n            sugestao_compra_60d: p.sugestao_compra_60d,\n            vendas_periodo_atual: p.vendas_30d_atual,\n            vendas_periodo_anterior: p.vendas_30d_anterior,\n            tendencia: p.tendencia,\n            variacao_percentual: p.variacao_percentual,\n            ultima_venda: p.ultima_venda_formatada,\n            dias_sem_venda: p.dias_sem_venda,\n            prioridade_compra: p.prioridade_compra,\n            alerta_estoque: p.alerta_estoque\n        }))\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2640,
        300
      ],
      "id": "processar-calculos",
      "name": "Processar CÃ¡lculos"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json; charset=utf-8"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        2880,
        300
      ],
      "id": "respond-json",
      "name": "Respond JSON"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        1600,
        500
      ],
      "id": "manual-trigger",
      "name": "Teste Manual"
    }
  ],
  "connections": {
    "Webhook Gerente Estoque": {
      "main": [
        [
          {
            "node": "Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config": {
      "main": [
        [
          {
            "node": "GET Estoque",
            "type": "main",
            "index": 0
          },
          {
            "node": "GET Vendas 60d",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET Estoque": {
      "main": [
        [
          {
            "node": "Merge Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET Vendas 60d": {
      "main": [
        [
          {
            "node": "Merge Dados",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Dados": {
      "main": [
        [
          {
            "node": "Processar CÃ¡lculos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar CÃ¡lculos": {
      "main": [
        [
          {
            "node": "Respond JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Teste Manual": {
      "main": [
        [
          {
            "node": "Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "gerente-estoque-workflow"
  }
}